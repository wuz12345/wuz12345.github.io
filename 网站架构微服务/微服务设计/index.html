
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="wuzhuang">
      
      
        <meta name="author" content="wuzhuang">
      
      
        <link rel="canonical" href="https://wuz12345.github.io/%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.16">
    
    
      
        <title>1. 微服务 - wuzhuang</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="wuzhuang" class="md-header__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            wuzhuang
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              1. 微服务
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="wuzhuang" class="md-nav__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    wuzhuang
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        简介
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        关于
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          LearnGo
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LearnGo" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          LearnGo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnGo/Read/" class="md-nav__link">
        简介
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          LearnC++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LearnC++" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          LearnC++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          模板和泛型编程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="模板和泛型编程" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          模板和泛型编程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/READ/" class="md-nav__link">
        简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/%E7%B1%BB%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        类模板
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/%E6%97%A0%E7%B1%BB%E5%9E%8B%E6%A8%A1%E6%9D%BF%E5%8F%82%E6%95%B0/" class="md-nav__link">
        非类型模板参数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        可变类型模板
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC/" class="md-nav__link">
        拷贝赋值
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Effiective Modern C++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Effiective Modern C++" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Effiective Modern C++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/Effective%20C%2B%2B/Item01/" class="md-nav__link">
        item1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/Effective%20C%2B%2B/Item02/" class="md-nav__link">
        item2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/Effective%20C%2B%2B/Item07/" class="md-nav__link">
        item7
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E5%B7%A6%E5%80%BC%E4%B8%8E%E5%8F%B3%E5%80%BC/" class="md-nav__link">
        左值与右值
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          LeetCode刷题
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LeetCode刷题" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          LeetCode刷题
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LeetCode%20%E5%88%B7%E9%A2%98/%E7%BA%BF%E6%80%A7%E8%A1%A8/" class="md-nav__link">
        线性表
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          webRTC
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="webRTC" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          webRTC
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../webrtc/FEC/FEC/" class="md-nav__link">
        FEC
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/wuz12345/mynote/edit/master/docs/网站架构微服务/微服务设计.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="1">1. 微服务<a class="headerlink" href="#1" title="Permanent link">&para;</a></h1>
<p>一些系统工作的小而自治的服务。</p>
<p>专注于做好一件事
自治性，解耦，正确地剑魔服务和API</p>
<p>好处：技术异构性，弹性（不可用和功能降级问题）,扩展，简化部属，与组织结构相匹配，可组合性，对可替代性的优化，</p>
<p>1.3 面相服务的架构SOA</p>
<h1 id="2">2. 演化式架构师<a class="headerlink" href="#2" title="Permanent link">&para;</a></h1>
<p>职责：愿景，同理心，合作，适应性，自治性，治理</p>
<h1 id="3">3. 如何建模服务<a class="headerlink" href="#3" title="Permanent link">&para;</a></h1>
<p>什么样的服务是好服务：
低耦合：修改一个服务无需修改另一个服务。限制两个服务之间的不同调用形式的数量
高内聚:相关的行为聚集一起</p>
<p>3.3限界上下文
共享的隐藏模型（领域驱动设计）
模块和服务:服务边界和领域的限界上下文保持一致
过早划分：</p>
<p>3.4 业务功能
建模服务时，应该将这些功能作为关键操作提供给其他协作者（其他服务）</p>
<p>3.5 逐步划分上下文</p>
<p>3.6 关于业务概念的沟通
修改系统的目的是为了满足业务需求
技术边界：</p>
<h1 id="4">4.集成<a class="headerlink" href="#4" title="Permanent link">&para;</a></h1>
<p>4.1寻找理想的集成技术
避免破坏性修改
保证API的技术无关性
使你的服务易于消费方式用
隐藏内部实现细节
为用户创建接口
共享数据库</p>
<p>4.4同步异步
4.5编排与协同
编排： 依赖于某个中心大脑指导并且驱动整个流程
协同：告知系统中各个部分的职责，细节留给他们自己。发布订阅。降低耦合度，但是需要对业务流程做跨服务监控。RPC 和 REST</p>
<p>4.6远程过程调用
缺点： 技术的耦合；本地调用和远程调用并不相同；脆弱性</p>
<p>4.7 REST</p>
<p>4.8实现基于事件的异步协作方式
微服务发布事件机制和消费者接受事件机制
尽量让消息中间件保持简单，把业务逻辑放在自己的服务中
关联ID对跨进程间的请求进行追踪</p>
<p>4.9 服务即状态机
4.10响应式扩展</p>
<p>4.11微服务世界中的DRY 和代码重用的危险：
跨服务可以适度违反DRY</p>
<p>语义化版本控制 MAJOR.MINOR.PATCH。通过语义化版本控制可以直接看出来是否有不兼容修改，调用方是否需要修改调用点代码。</p>
<h1 id="5">5.分解单块系统<a class="headerlink" href="#5" title="Permanent link">&para;</a></h1>
<p>通过限界上下文来确定业务拆分边界。</p>
<p>SchemaSpy 工具生成数据库之间的关系图</p>
<p>拆除外键：通过API 来提供访问。（这样做会增加请求减慢访问速度，需要做个权衡）
作者这里推荐先做数据库拆分，之后去拆分业务代码。</p>
<p>数据库重构: 拆分过程可以根据业务边界重新设计db</p>
<p>拆分之后如何处理事务不一致问题：</p>
<ul>
<li>再试一次，比如一个操作成功了，一个失败了。但是要保证重试可以修复这个问题(最终一致性)</li>
<li>终止整个操作。发起一个补偿事务抵消之前的操作，但是补偿也可能失败，不好处理，可能需要一个后台</li>
<li>分布式事务：两阶段提交.尽量用现有的技术方案</li>
</ul>
<p>把设计画在白板上，在你认为的服务边界上运行用例，看看会发生什么。</p>
<p>CRC(class-responsibility-collaboration): 类、职责、交互卡片</p>
<h1 id="6">6 部署<a class="headerlink" href="#6" title="Permanent link">&para;</a></h1>
<p>CI (continuous intergration) 持续集成</p>
<ul>
<li>是否每天签入代码到主线</li>
<li>是否有一组测试验证修改</li>
<li>构建失败后，是否把修复 CI 当做第一优先级事情来做</li>
</ul>
<p>CD(continuous delivery) 持续交付</p>
<h1 id="7">7 测试<a class="headerlink" href="#7" title="Permanent link">&para;</a></h1>
<p>stub vs mock</p>
<p>stub: 打桩是指为被测服务的请求创建一些有预设相应的打桩服务。
mock 还会进一步验证请求本身是否被正确调用。</p>
<p>《测试驱动的面向对象软件开发》</p>
<h1 id="8">8 监控<a class="headerlink" href="#8" title="Permanent link">&para;</a></h1>
<p>监控小的服务，然后聚合起来看整体。</p>
<p>日志: ELK elastic-search + logstash + kibana</p>
<p>多个服务的指标跟踪：graphite</p>
<p>zipkin 跨多个系统边界跟踪调用</p>
<h1 id="9">9 安全<a class="headerlink" href="#9" title="Permanent link">&para;</a></h1>
<p>身份验证和授权。分布式系统下，我们希望有一个单一的标识且只需要一次验证。</p>
<p>单点登录SSO(single signon)；使用网关实现单点登录。</p>
<p>服务间身份验证和授权：在边界内允许一切；https 基本身份验证</p>
<h2 id="93">9.3 静态数据的安全<a class="headerlink" href="#93" title="Permanent link">&para;</a></h2>
<p>使用众所周知的加密算法</p>
<h2 id="94">9.4 深度防御<a class="headerlink" href="#94" title="Permanent link">&para;</a></h2>
<p>防火墙(iptables)；日志(踢出敏感信息)；入侵检测和防御系统；网络隔离</p>
<h2 id="97">9.7 个人因素<a class="headerlink" href="#97" title="Permanent link">&para;</a></h2>
<p>心怀不满的雇员损害你的系统</p>
<h1 id="10">10 康威定律和系统设计<a class="headerlink" href="#10" title="Permanent link">&para;</a></h1>
<p>任何组织在设计一套系统(广义概念的系统)时，所交付的设计方案在结构上都与该组织的沟通结构保持一致。</p>
<p>组织的耦合度越低，创建的系统模块化就越好，否则越差。</p>
<h1 id="11">11 规模化微服务<a class="headerlink" href="#11" title="Permanent link">&para;</a></h1>
<h2 id="111">11.1 故障无处不在<a class="headerlink" href="#111" title="Permanent link">&para;</a></h2>
<p>从统计学看，规模化后故障成为必然事件。
假设一切都会失败，会让你从不同的角度去思考如何解决问题。</p>
<p>考虑是否扩展系统，首先尝试理解一下需求：</p>
<ul>
<li>响应时间/延迟</li>
<li>可用性</li>
<li>数据持久性</li>
</ul>
<h2 id="113">11.3 功能降级<a class="headerlink" href="#113" title="Permanent link">&para;</a></h2>
<p>如果这个微服务宕了会发生什么？</p>
<h2 id="114">11.4 架构性安全措施<a class="headerlink" href="#114" title="Permanent link">&para;</a></h2>
<p>一个无法控制的下游服务，可以让整个系统宕掉。</p>
<h2 id="115">11.5 反脆弱的组织<a class="headerlink" href="#115" title="Permanent link">&para;</a></h2>
<p>混乱猴子，故意在系统中做破坏</p>
<p>做什么来应对系统故障呢？</p>
<ul>
<li>超时。给所有的跨进程调用设置超时，并选择一个默认的超时时间。记录日志并响应调整</li>
<li>断路器。对下游资源请求发生一定量的失败后，断路器会打开。接下来所有的请求在断路器打开的状态下，会快速地失败。
  一段时间后，客户端发送一些请求查看服务是否恢复，如果正常响应了，重置断路器。
  Hystrix 基于 JVM 的断路器，附带监控</li>
<li>舱壁(bulkhead)：关注点分离。每个下游服务使用不同的连接池</li>
<li>隔离，允许下游服务离线</li>
<li>幂等, 多次执行产生的影响和一次执行的影响相同</li>
</ul>
<h2 id="117">11.7 扩展<a class="headerlink" href="#117" title="Permanent link">&para;</a></h2>
<ul>
<li>更强大的主机（垂直扩展）；</li>
<li>拆分负载；</li>
<li>分散风险；</li>
<li>负载均衡。aws elbs(elastci load balancers)</li>
<li>基于 worker 的系统。</li>
<li>重新设计服务</li>
</ul>
<h2 id="118">11.8 扩展数据库<a class="headerlink" href="#118" title="Permanent link">&para;</a></h2>
<h3 id="1181">11.8.1 服务的可用性和数据的持久性<a class="headerlink" href="#1181" title="Permanent link">&para;</a></h3>
<p>数据库副本</p>
<h3 id="1182">11.8.2 扩展读取<a class="headerlink" href="#1182" title="Permanent link">&para;</a></h3>
<p>使用只读副本。最终一致性</p>
<h3 id="1183">11.8.3 扩展写操作<a class="headerlink" href="#1183" title="Permanent link">&para;</a></h3>
<p>通过哈希写分片。</p>
<h3 id="1184">11.8.4 共享数据库基础设施<a class="headerlink" href="#1184" title="Permanent link">&para;</a></h3>
<h2 id="119">11.9 缓存<a class="headerlink" href="#119" title="Permanent link">&para;</a></h2>
<h3 id="1191">11.9.1 客户端、代理和服务器缓存<a class="headerlink" href="#1191" title="Permanent link">&para;</a></h3>
<p>客户端：减少网络调用，减少下游负载。但是改变缓存方式和失效数据比较棘手</p>
<p>代理服务器：squid 或varnish。增加网络跳数(network hops)，但是相比性能优化来说可忽略</p>
<p>服务器：适合多客户端。追踪和统计命中率</p>
<h3 id="1192-http">11.9.2 HTTP 缓存<a class="headerlink" href="#1192-http" title="Permanent link">&para;</a></h3>
<p>cache-control: 告诉客户端是否缓存资源，缓存几秒。</p>
<p>Expires: 指定改日知和时间后被认为失效</p>
<p>ETag： 标识资源是否已改变</p>
<p>《Rest 实战》</p>
<h3 id="1193">11.9.3 为写使用缓存<a class="headerlink" href="#1193" title="Permanent link">&para;</a></h3>
<p>使用 writebehind 方式使用缓存</p>
<h3 id="1194">11.9.4 为弹性使用缓存<a class="headerlink" href="#1194" title="Permanent link">&para;</a></h3>
<p>可以使用缓存中的数据保证某些场景服务不会宕机（但是数据可能过时，总比挂了好）</p>
<h3 id="1195">11.9.5 隐藏源服务<a class="headerlink" href="#1195" title="Permanent link">&para;</a></h3>
<p>让请求快速失败，确保不占用资源或增加延迟，给下游服务恢复机会</p>
<h3 id="1196">11.9.6 保持简单<a class="headerlink" href="#1196" title="Permanent link">&para;</a></h3>
<p>先保持简单，使用缓存之前慎重考虑</p>
<h2 id="1111-cap">11.11 CAP 定理<a class="headerlink" href="#1111-cap" title="Permanent link">&para;</a></h2>
<ul>
<li>一致性（consistency）:访问多个节点能得到同样的值</li>
<li>可用性(availability): 每个请求都能获得响应</li>
<li>分区容忍性(partition tolerance): 集群中某些节点失联后，集群整体还能继续进行服务的能力</li>
</ul>
<p>考虑使用双主数据库来进行数据库同步，加入两个库之间断开了：</p>
<ul>
<li>牺牲一致性。AP 系统。最终一致性，用户可能看到失效的数据</li>
<li>牺牲可用性。CP系统。为了让数据一致，拒绝用户请求。保证多个节点一致性很难。</li>
<li>牺牲分区容忍性。不存在，除非单独的进程不跨越网络</li>
</ul>
<p>需要权衡使用 AP 还是 CP。构建 AP 比 CP 很容易一些。</p>
<h2 id="1112">11.12 服务发现<a class="headerlink" href="#1112" title="Permanent link">&para;</a></h2>
<p>常见的服务发现解决方案：</p>
<ul>
<li>DNS</li>
</ul>
<h2 id="1113">11.13 动态服务注册<a class="headerlink" href="#1113" title="Permanent link">&para;</a></h2>
<ul>
<li>Zookeeper</li>
<li>Consul：支持配置管理和服务发现</li>
<li>Eureka(netflix):</li>
</ul>
<h2 id="1114">11.14 文档服务<a class="headerlink" href="#1114" title="Permanent link">&para;</a></h2>
<ul>
<li>Swagger</li>
<li>HAL和 HAL 浏览器。hypertext application language</li>
</ul>
<h1 id="12">12 总结<a class="headerlink" href="#12" title="Permanent link">&para;</a></h1>
<h2 id="121">12.1 微服务原则<a class="headerlink" href="#121" title="Permanent link">&para;</a></h2>
<p>微服务(自治的小服务）的原则：</p>
<ul>
<li>围绕业务概念建模: 使用限界界上下文</li>
<li>自动化: 持续交付</li>
<li>隐藏内部实现细节:隐藏数据库。使用技术无关的 api，比如 rest/rpc</li>
<li>一切都去中心化: 团队保持对服务的所有权；内部开源模式；康威定律；内聚性</li>
<li>可独立部署: 你的消费者应该自己决定何时更新</li>
<li>隔离失败: 超时；断路；舱壁。CAP</li>
<li>高度可观察: 聚合日志和数据</li>
</ul>
<h2 id="122">12.2 什么时候不该使用微服务？<a class="headerlink" href="#122" title="Permanent link">&para;</a></h2>
<p>先花时间了解系统做什么的，尝试识别清晰的模块边界。</p>
<p>首先构建单块系统，稳定之后再考虑拆分</p>
<p>花时间构建工具和实践，管理微服务。</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
        <script src="../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>