
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="wuzhuang">
      
      
        <meta name="author" content="wuzhuang">
      
      
        <link rel="canonical" href="https://wuz12345.github.io/golang/building_restful_web_services_with_go/book/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.16">
    
    
      
        <title>Book - wuzhuang</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-getting-started-with-rest-api-development" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="wuzhuang" class="md-header__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            wuzhuang
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Book
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="wuzhuang" class="md-nav__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    wuzhuang
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        简介
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        关于
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          LearnC++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LearnC++" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          LearnC++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC/" class="md-nav__link">
        拷贝赋值
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Effiective Modern C++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Effiective Modern C++" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Effiective Modern C++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/Effective%20C%2B%2B/Item01/" class="md-nav__link">
        item1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/Effective%20C%2B%2B/Item02/" class="md-nav__link">
        item2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/Effective%20C%2B%2B/Item07/" class="md-nav__link">
        item7
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/%E5%B7%A6%E5%80%BC%E4%B8%8E%E5%8F%B3%E5%80%BC/" class="md-nav__link">
        左值与右值
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          LeetCode刷题
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LeetCode刷题" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          LeetCode刷题
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LeetCode%20%E5%88%B7%E9%A2%98/Zigzag-Conversion/" class="md-nav__link">
        之字形转换
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LeetCode%20%E5%88%B7%E9%A2%98/%E7%BA%BF%E6%80%A7%E8%A1%A8/" class="md-nav__link">
        线性表
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          有趣的知识
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="有趣的知识" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          有趣的知识
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%9F%A5%E8%AF%86/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8E%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA/" class="md-nav__link">
        正则表达式与有限状态机
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          webRTC
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="webRTC" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          webRTC
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../webrtc/FEC/FEC/" class="md-nav__link">
        FEC
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/wuz12345/mynote/edit/master/docs/golang/building_restful_web_services_with_go/book.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<p>《Building RESTful Web services with GO》 涉及面比较广，但是讲得太浅</p>
<h1 id="1-getting-started-with-rest-api-development">1. Getting started with REST API Development<a class="headerlink" href="#1-getting-started-with-rest-api-development" title="Permanent link">&para;</a></h1>
<p>Live reloading the application with supervisord and gulp</p>
<h1 id="2-handling-routing-for-rest-srevices">2. Handling Routing for Rest Srevices<a class="headerlink" href="#2-handling-routing-for-rest-srevices" title="Permanent link">&para;</a></h1>
<h3 id="servemux-a-basic-router-in-go">ServeMux a basic router in Go<a class="headerlink" href="#servemux-a-basic-router-in-go" title="Permanent link">&para;</a></h3>
<p><code>go get github.com/julienschmidt/httprouter</code></p>
<div class="highlight"><pre><span></span><code>// execService.go

// Package main  provides ...
package main

import (
    &quot;bytes&quot;
    &quot;fmt&quot;
    &quot;log&quot;
    &quot;net/http&quot;
    &quot;os/exec&quot;

    &quot;github.com/julienschmidt/httprouter&quot;
)

func getCommandOutput(command string, arguments ...string) string {
    cmd := exec.Command(command, arguments...) //unpack
    var out bytes.Buffer
    var stderr bytes.Buffer
    cmd.Stdout = &amp;out
    cmd.Stderr = &amp;stderr
    err := cmd.Start()
    if err != nil {
        log.Fatal(fmt.Sprint(err) + &quot;: &quot; + stderr.String())
    }
    err = cmd.Wait()
    if err != nil {
        log.Fatal(fmt.Sprint(err) + &quot;: &quot; + stderr.String())
    }
    return out.String()
}

func goVersion(w http.ResponseWriter, r *http.Request, params httprouter.Params) {
    fmt.Fprintf(w, getCommandOutput(&quot;/usr/local/bin/go&quot;, &quot;version&quot;))
}

func getFileContent(w http.ResponseWriter, r *http.Request, params httprouter.Params) {
    fmt.Fprintf(w, getCommandOutput(&quot;/bin/cat&quot;, params.ByName(&quot;name&quot;)))
}

func main() {
    router := httprouter.New()
    router.GET(&quot;/api/v1/go-version&quot;, goVersion)
    router.GET(&quot;/api/v1/show-file/:name&quot;, getFileContent)
    log.Fatal(http.ListenAndServe(&quot;:8000&quot;, router))
}
</code></pre></div>
<h3 id="building-the-simple-static-file-server">Building the simple static file server<a class="headerlink" href="#building-the-simple-static-file-server" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>package main

import (
    &quot;log&quot;
    &quot;net/http&quot;

    &quot;github.com/julienschmidt/httprouter&quot;
)

func main() {
    router := httprouter.New()
    router.ServeFiles(&quot;/static/*filepath&quot;, http.Dir(&quot;/users/naren/static&quot;))
    log.Fatal(http.ListenAndServe(&quot;:8000&quot;, router))
}
</code></pre></div>
<h3 id="gorilla-mux-a-powerful-http-router">Gorilla Mux, a powerful HTTP router<a class="headerlink" href="#gorilla-mux-a-powerful-http-router" title="Permanent link">&para;</a></h3>
<ul>
<li>Path-based matching</li>
<li>Query-based matching</li>
<li>Domain-based matching</li>
<li>Sub-domain based matching</li>
<li>Reverse URL generation</li>
</ul>
<h1 id="3-working-with-middleware-and-rpc">3. Working with Middleware and RPC<a class="headerlink" href="#3-working-with-middleware-and-rpc" title="Permanent link">&para;</a></h1>
<h3 id="what-is-middleware">What is middleware?<a class="headerlink" href="#what-is-middleware" title="Permanent link">&para;</a></h3>
<p>When a piece of code needs to be executed for every request or subset of HTTP requests.</p>
<h3 id="creating-a-basic-middleware">Creating a basic middleware<a class="headerlink" href="#creating-a-basic-middleware" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>// custommiddleware.go
package main

func middleware(handler http.handler) http.handler {
    return http.handlerfunc(func(w http.responsewriter, r *http.request) {
        fmt.println(&quot;executing middleware before request phase!&quot;)
        //pass control back to handler
        handler.servehttp(w, r)
        fmt.println(&quot;executing middleware after response phase!&quot;)
    })
}

func mainlogic(w http.responsewriter, r *http.request) {
    // business logic here
    fmt.println(&quot;executing mainhandler&quot;)
    w.write([]byte(&quot;ok&quot;))
}

func main() {
    manlogichandler := http.handlerfunc(mainlogic)
    http.handler(&quot;/&quot;, middleware(manlogichandler))
    http.listenandserve(&quot;:8000&quot;, nil)
}
</code></pre></div>
<h3 id="multiple-middleware-and-chaining">Multiple middleware and chaining<a class="headerlink" href="#multiple-middleware-and-chaining" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>// cityAPI.go
package main

import (
    &quot;encoding/json&quot;
    &quot;fmt&quot;
    &quot;net/http&quot;
)

type city struct {
    Name string
    Area uint64
}

func mainLogic(w http.ResponseWriter, r *http.Request) {
    if r.Method == &quot;POST&quot; {
        var tempCity city
        decoder := json.NewDecoder(r.Body)
        err := decoder.Decode(&amp;tempCity)
        if err != nil {
            panic(err)
        }
        defer r.Body.Close()
        // creat logic
        fmt.Printf(&quot;%s %d&quot;, tempCity.Name, tempCity.Area)
        // tell everything is fine
        w.WriteHeader(http.StatusOK)
        w.Write([]byte(&quot;201 - Created&quot;))
    } else {
        w.WriteHeader(http.StatusMethodNotAllowed)
        w.Write([]byte(&quot;405 - Method Not Allowed&quot;))
    }
}

func main() {
    http.HandleFunc(&quot;/city&quot;, mainLogic)
    http.ListenAndServe(&quot;:8000&quot;, nil)
}
</code></pre></div>
<p>抽象出来俩middleware:</p>
<div class="highlight"><pre><span></span><code>package main

import (
    &quot;encoding/json&quot;
    &quot;fmt&quot;
    &quot;log&quot;
    &quot;net/http&quot;
    &quot;strconv&quot;
    &quot;time&quot;
)

type city struct {
    name string
    area uint64
}

// middleware to check content type as json
func filtercontenttype(handler http.handler) http.handler {
    return http.handlerfunc(func(w http.responsewriter, r *http.request) {
        log.println(&quot;currently in the check content type middleware&quot;)
        // filtering request by mime type
        if r.header.get(&quot;content-type&quot;) != &quot;application/json&quot; {
            w.writeheader(http.statusunsupportedmediatype)
            w.write([]byte(&quot;415 - unsupported media type. please send json&quot;))
            return
        }
        handler.servehttp(w, r)
    })
}

// middle to add server timestamp for response cookie
func setservertimecookie(handler http.handler) http.handler {
    return http.handlerfunc(func(w http.responsewriter, r *http.request) {
        handler.servehttp(w, r)
        cookie := http.cookie{name: &quot;server-time(utc)&quot;, value: strconv.formatint(time.now().unix(), 10)}
        http.setcookie(w, &amp;cookie)
        log.println(&quot;currently in the set server time middleware&quot;)
    })
}

func mainlogic(w http.responsewriter, r *http.request) {
    if r.method == &quot;post&quot; {
        var tempcity city
        decoder := json.newdecoder(r.body)
        err := decoder.decode(&amp;tempcity)
        if err != nil {
            panic(err)
        }
        defer r.body.close()
        // creat logic
        fmt.printf(&quot;%s %d&quot;, tempcity.name, tempcity.area)
        // tell everything is fine
        w.writeheader(http.statusok)
        w.write([]byte(&quot;201 - created&quot;))
    } else {
        w.writeheader(http.statusmethodnotallowed)
        w.write([]byte(&quot;405 - method not allowed&quot;))
    }
}

func main() {
    mainlogichnadler := http.handlerfunc(mainlogic)
    http.handler(&quot;/city&quot;, filtercontenttype(setservertimecookie(mainlogichnadler)))
    http.listenandserve(&quot;:8000&quot;, nil)
}
</code></pre></div>
<h3 id="paniless-middleware-chaining-with-alice">Paniless middleware chaining with Alice<a class="headerlink" href="#paniless-middleware-chaining-with-alice" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>//go get github.com/justinas/alice

func main() {
    mainLogicHandler := http.HandlerFunc(mainLogic)
    chain := alice.New(filterContentType, setServerTimeCookie).Then(mainLogicHandler)
    http.Handle(&quot;/city&quot;, chain)
    http.ListenAndServe(&quot;:8000&quot;, nil)
}
</code></pre></div>
<h3 id="using-gorillas-handlers-middleware-for-logging">Using Gorilla&rsquo;s Handlers middleware for Logging<a class="headerlink" href="#using-gorillas-handlers-middleware-for-logging" title="Permanent link">&para;</a></h3>
<ul>
<li>LoggingHandler</li>
<li>CompressingHandler: for zipping the responses</li>
<li>RecoveryHandler: for recovering from unexpected panics</li>
</ul>
<h3 id="what-is-rpc">What is RPC?<a class="headerlink" href="#what-is-rpc" title="Permanent link">&para;</a></h3>
<p>&ldquo;net/rpc&rdquo;</p>
<h3 id="json-rpc-using-gorilla-rpc">JSON RPC using Gorilla RPC<a class="headerlink" href="#json-rpc-using-gorilla-rpc" title="Permanent link">&para;</a></h3>
<h1 id="4-simplifying-restful-services-with-popular-go-frameworks">4. Simplifying RESTful Services with Popular Go Frameworks<a class="headerlink" href="#4-simplifying-restful-services-with-popular-go-frameworks" title="Permanent link">&para;</a></h1>
<h3 id="go-restful-a-framework-for-rest-api-creation">go-restful, a framework for REST API creation<a class="headerlink" href="#go-restful-a-framework-for-rest-api-creation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>package main

import (
    &quot;fmt&quot;
    &quot;io&quot;
    &quot;net/http&quot;
    &quot;time&quot;

    &quot;github.com/emicklei/go-restful&quot;
)

// brew install sqlite3
// go get github.com/emicklei/go-restful
// a simple ping server echoes the server time back to the client
func main() {
    webservice := new(restful.WebService)
    webservice.Route(webservice.GET(&quot;/ping&quot;).To(pingTime))
    restful.Add(webservice)
    http.ListenAndServe(&quot;:8000&quot;, nil)
}

func pingTime(req *restful.Request, resp *restful.Response) {
    io.WriteString(resp, fmt.Sprintf(&quot;%s&quot;, time.Now()))
}

// curl -X GET &quot;http://localhost:8000/ping&quot;
</code></pre></div>
<h3 id="crud-and-sqlite3-basics">CRUD and SQLite3 basics<a class="headerlink" href="#crud-and-sqlite3-basics" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>// sqliteFundamentals.go
package main

import (
    &quot;database/sql&quot;
    &quot;log&quot;

    _ &quot;github.com/mattn/go-sqlite3&quot;
)

// go get github.com/mattn/go-sqlite3

type Book struct {
    id     int
    name   string
    author string
}

func main() {
    db, err := sql.Open(&quot;sqlite3&quot;, &quot;./books.db&quot;)
    log.Println(db)
    if err != nil {
        log.Println(err)
    }
    //create table
    statement, err := db.Prepare(&quot;create table if not exists books(id integer primary key, isbn integer, author(varchar(64), name varchar(64) NULL)&quot;)
    if err != nil {
        log.Println(&quot;Error in creating table&quot;)
    } else {
        log.Println(&quot;success created table books&quot;)
    }
    statement.Exec()
    // Create
    statement, _ = db.Prepare(&quot;INSERT INTO books (name, author, isbn) VALUES (?, ?, ?)&quot;)
    statement.Exec(&quot;A Tale of Two Cities&quot;, &quot;Charles Dickens&quot;, 140430547)
    log.Println(&quot;Inserted the book into database!&quot;)
    // Read
    rows, _ := db.Query(&quot;SELECT id, name, author FROM books&quot;)
    var tempBook Book
    for rows.Next() {
        rows.Scan(&amp;tempBook.id, &amp;tempBook.name, &amp;tempBook.author)
        log.Printf(&quot;ID:%d, Book:%s, Author:%s\n&quot;, tempBook.id,
            tempBook.name, tempBook.author)
    }
    // Update
    statement, _ = db.Prepare(&quot;update books set name=? where id=?&quot;)
    statement.Exec(&quot;The Tale of Two Cities&quot;, 1)
    log.Println(&quot;Successfully updated the book in database!&quot;)
    //Delete
    statement, _ = db.Prepare(&quot;delete from books where id=?&quot;)
    statement.Exec(1)
    log.Println(&quot;Successfully deleted the book in database!&quot;)
}

// 略坑啊：
// This program runs on Windows and Linux without any problem. In Go versions less than 1.8.1, you may see problems on macOS X such as Signal Killed. This is because of the Xcode version; please keep this in mind.
</code></pre></div>
<h3 id="building-a-metro-rail-api-with-go-restful">Building a Metro Rail APi with go-restful<a class="headerlink" href="#building-a-metro-rail-api-with-go-restful" title="Permanent link">&para;</a></h3>
<p>// go get github.com/emicklei/go-restful</p>
<h3 id="building-restful-apis-with-the-gin-framework">Building RESTful APIs with the Gin framework<a class="headerlink" href="#building-restful-apis-with-the-gin-framework" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>// go get github.com/gin-gonic/gin
// ginBasic.go
package main

import (
    &quot;time&quot;

    &quot;github.com/gin-gonic/gin&quot;
)

func main() {
    r := gin.Default()
    r.GET(&quot;/pingTime&quot;, func(c *gin.Context) {
        c.JSON(200, gin.H{&quot;serverTime&quot;: time.Now().UTC()})
    })
    r.Run(&quot;:8000&quot;)
}
</code></pre></div>
<h3 id="building-a-restful-api-with-revelgo">Building a RESTful API with Revel.go<a class="headerlink" href="#building-a-restful-api-with-revelgo" title="Permanent link">&para;</a></h3>
<p>Like Python&rsquo;s Django.</p>
<p>go get github.com/revel/revel</p>
<h1 id="5-working-with-mongodb-and-go-to-create-rest-apis">5. Working with MongoDB and Go to Create REST APIs<a class="headerlink" href="#5-working-with-mongodb-and-go-to-create-rest-apis" title="Permanent link">&para;</a></h1>
<h3 id="introducig-mgo-a-mongodb-deiver-for-go">Introducig mgo, a MongoDB deiver for Go<a class="headerlink" href="#introducig-mgo-a-mongodb-deiver-for-go" title="Permanent link">&para;</a></h3>
<p>get get gopkg.in/mgo.v2</p>
<h1 id="6-wokring-with-protocol-bufffers-and-grpc">6. Wokring with Protocol Bufffers and GRPC<a class="headerlink" href="#6-wokring-with-protocol-bufffers-and-grpc" title="Permanent link">&para;</a></h1>
<h3 id="protocol-buffer-language">Protocol buffer language<a class="headerlink" href="#protocol-buffer-language" title="Permanent link">&para;</a></h3>
<ul>
<li>Scalar values, Enumerations, Defalut values, Nested values, Unknown types</li>
</ul>
<div class="highlight"><pre><span></span><code>syntax &#39;proto3&#39;;

message NetworkInterface {
  int index=1;
  int mtu=2;
  string name=3;
  string hardwareaddr=4;
}
</code></pre></div>
<p>the protocol buffer message will be converted to a Go struct and fiels are filled with empty defaut values.</p>
<h3 id="compiling-a-protocol-buffer-with-protoc">Compiling a protocol buffer with protoc<a class="headerlink" href="#compiling-a-protocol-buffer-with-protoc" title="Permanent link">&para;</a></h3>
<p>install protobuf compiler on your meachine.  brew install protobuf</p>
<h3 id="grpc">GRPC<a class="headerlink" href="#grpc" title="Permanent link">&para;</a></h3>
<p>go get google.golang.org/grpc</p>
<p>go get -u github.com/golang/protobuf/protoc-gen-go</p>
<p>Grpc has the following benefits over HTTP/REST/JSON architecture:</p>
<ul>
<li>GPRC use http/2, which is a binary protocol</li>
<li>Header compression is possible in http2</li>
<li>we can multiplex many requests on one connection</li>
<li>Usage of protobufs for strict typing of data</li>
<li>streaming of requests or responses is possible instead of request/response transactions</li>
</ul>
<h3 id="bidirectional-streaming-with-grpc">Bidirectional streaming with GRPC<a class="headerlink" href="#bidirectional-streaming-with-grpc" title="Permanent link">&para;</a></h3>
<h1 id="7-working-with-postgresql-json-and-go">7. Working with PostgreSQL, JSON, and Go<a class="headerlink" href="#7-working-with-postgresql-json-and-go" title="Permanent link">&para;</a></h1>
<h3 id="install-postgresql">install PostgreSQL<a class="headerlink" href="#install-postgresql" title="Permanent link">&para;</a></h3>
<p>brew install postgresql &amp;&amp; brew services start postgresql // port 5432
// use psql shell create new use and database and</p>
<h3 id="pq-a-pure-postgresql-database-driver-for-go">pq, a pure PostgreSQL database driver for Go<a class="headerlink" href="#pq-a-pure-postgresql-database-driver-for-go" title="Permanent link">&para;</a></h3>
<p>go get github.com/lib/pq</p>
<h3 id="exploring-thj-json-store-in-postgresql">Exploring thj JSON store in PostgreSQL<a class="headerlink" href="#exploring-thj-json-store-in-postgresql" title="Permanent link">&para;</a></h3>
<p>PostgreSQL &gt; 9.2 has a feature called the JSON store.</p>
<h3 id="gorm-a-powerful-orm-for-go">GORM, a powerful ORM for GO<a class="headerlink" href="#gorm-a-powerful-orm-for-go" title="Permanent link">&para;</a></h3>
<p>go get -u github.com/jinzhu/gorm</p>
<h1 id="8-building-a-rest-api-client-in-go-and-unit-testing">8. Building a REST API Client in Go and Unit Testing<a class="headerlink" href="#8-building-a-rest-api-client-in-go-and-unit-testing" title="Permanent link">&para;</a></h1>
<h3 id="basics-for-writing-a-command-line-tool-in-go">Basics for writing a command-line tool in Go<a class="headerlink" href="#basics-for-writing-a-command-line-tool-in-go" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>// flagExample.go
package main

import (
    &quot;flag&quot;
    &quot;log&quot;
)

var name = flag.String(&quot;name&quot;, &quot;stranger&quot;, &quot;you wonderfule name&quot;)

func main() {
    flag.Parse()
    log.Printf(&quot;Hello %s&quot;, *name)
}
// ./flagExample -name laowang or ./flagExample -name=laowang
</code></pre></div>
<h3 id="cli-a-library-for-building-beautiful-clients">CLI - a library for building beautiful clients<a class="headerlink" href="#cli-a-library-for-building-beautiful-clients" title="Permanent link">&para;</a></h3>
<p>go get github.com/urfave/cli</p>
<div class="highlight"><pre><span></span><code>// cliBasci.go
package main

import (
    &quot;log&quot;
    &quot;os&quot;

    &quot;github.com/urfave/cli&quot;
)

func main() {
    app := cli.NewApp()
    app.Flags = []cli.Flag{
        cli.StringFlag{
            Name:  &quot;name&quot;,
            Value: &quot;stranger&quot;,
            Usage: &quot;you wonderful name&quot;,
        },
        cli.IntFlag{
            Name:  &quot;age&quot;,
            Value: 0,
            Usage: &quot;your graceful age&quot;,
        },
    }
    app.Action = func(c *cli.Context) error {
        log.Printf(&quot;Hello %s (%d years), Welcome to the command line world&quot;, c.String(&quot;name&quot;), c.Int(&quot;age&quot;))
        return nil
    }
    app.Run(os.Args)
}
</code></pre></div>
<h3 id="collecting-command-line-arguments-in-cli">Collecting command-line arguments in CLI<a class="headerlink" href="#collecting-command-line-arguments-in-cli" title="Permanent link">&para;</a></h3>
<p><img alt="" src="../flag.png" /></p>
<div class="highlight"><pre><span></span><code>// storeMarks.go
package main

import (
    &quot;log&quot;
    &quot;os&quot;

    &quot;github.com/urfave/cli&quot;
)

func main() {
    app := cli.NewApp()
    // define flags
    app.Flags = []cli.Flag{
        cli.StringFlag{
            Name:  &quot;save&quot;,
            Value: &quot;no&quot;,
            Usage: &quot;Should save to database (yes/no)&quot;,
        },
    }

    app.Version = &quot;1.0&quot;
    // define action
    app.Action = func(c *cli.Context) error {
        var args []string
        if c.NArg() &gt; 0 {
            // Fetch arguments in a array
            args = c.Args()
            personName := args[0]
            marks := args[1:len(args)]
            log.Println(&quot;Person: &quot;, personName)
            log.Println(&quot;marks&quot;, marks)
        }
        // check the flag value
        if c.String(&quot;save&quot;) == &quot;no&quot; {
            log.Println(&quot;Skipping saving to the database&quot;)
        } else {
            // Add database logic here
            log.Println(&quot;Saving to the database&quot;, args)
        }
        return nil
    }

    app.Run(os.Args)
}

// ./storeMarks --save=yes Albert 89 85 97
</code></pre></div>
<h3 id="grequests-a-rest-api-package-for-go">grequests - a REST API package for GO<a class="headerlink" href="#grequests-a-rest-api-package-for-go" title="Permanent link">&para;</a></h3>
<p>go get -u github.com/levigross/grequests</p>
<div class="highlight"><pre><span></span><code>package main

import (
    &quot;log&quot;

    &quot;github.com/levigross/grequests&quot;
)

func main() {
    resp, err := grequests.GET(&quot;http://httpbin.org/get&quot;, nil)
    if err != nil {
        log.Fatalln(&quot;Unabled to make requests: &quot;, err)
    }
    log.Println(resp.String())
}
package main

import (
    &quot;log&quot;

    &quot;github.com/levigross/grequests&quot;
)

func main() {
    resp, err := grequests.GET(&quot;http://httpbin.org/get&quot;, nil)
    if err != nil {
        log.Fatalln(&quot;Unabled to make requests: &quot;, err)
    }
    log.Println(resp.String())
}
/*
type Response struct {
    Ok bool
    Error error
    RawResponse *http.Response
    StatusCode int
    Header http.Header
}
*/
</code></pre></div>
<h3 id="getting-comfortable-with-the-github-rest-api">Getting comfortable with the GitHub REST API<a class="headerlink" href="#getting-comfortable-with-the-github-rest-api" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>// https://developer.github.com/v3/

// export GITHUB_TOKEN=YOUR_GITHUB_ACCESS_TOKEN
// getRepos.go
package main

import (
  &quot;github.com/levigross/grequests&quot;
  &quot;log&quot;
  &quot;os&quot;
)

var GITHUB_TOKEN = os.Getenv(&quot;GITHUB_TOKEN&quot;)
var requestOptions = &amp;grequests.RequestOptions{Auth: []string{GITHUB_TOKEN, &quot;x-oauth-basic&quot;}}

type Repo struct {
  ID int `json:&quot;id&quot;`
  Name string `json:&quot;name&quot;`
  FullName string  `json:&quot;full_name&quot;`
  Forks int `json:&quot;forks&quot;`
  Private bool `json:&quot;private&quot;`
}

func getStats(url string) *grequests.Response{
  resp, err := grequests.Get(url, requestOptions)
  // You can modify the request by passing an optional RequestOptions struct
  if err != nil {
    log.Fatalln(&quot;Unable to make request: &quot;, err)
  }
  return resp
}

func main() {
  var repos []Repo
  var repoUrl = &quot;https://api.github.com/users/torvalds/repos&quot;
  resp := getStats(repoUrl)
  resp.JSON(&amp;repos)
  log.Println(repos)
}
</code></pre></div>
<h3 id="using-redis-for-caching-the-api-data">Using Redis for caching the API data<a class="headerlink" href="#using-redis-for-caching-the-api-data" title="Permanent link">&para;</a></h3>
<p>go get github.com/go-redis/redis</p>
<h3 id="creating-a-unit-testing-tool-for-our-url-shortening-service">Creating a unit testing tool for our URL shortening service<a class="headerlink" href="#creating-a-unit-testing-tool-for-our-url-shortening-service" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>package main_test

import (
    &quot;net/http&quot;
    &quot;testing&quot;
)

func TestGetoOriginalURL(t *testing.T) {
    response, err := http.Get(&quot;http://localhost:8000/v1/short/1&quot;)
    if http.StatusOK != response.StatusCode {
        t.Errorf(&quot;Expected response code %d. Got %d\n&quot;, http.StatusOK)
    }
    if err != nil {
        t.Errorf(&quot;encoutered an error:&quot;, err)
    }
}
</code></pre></div>
<h1 id="9-scaling-our-rest-api-using-microservices">9. Scaling Our REST API Using Microservices<a class="headerlink" href="#9-scaling-our-rest-api-using-microservices" title="Permanent link">&para;</a></h1>
<p>The disadvantage list of a monolithic application could be:</p>
<ul>
<li>Tightly coupled architecture</li>
<li>Single point of failure</li>
<li>Velocity of adding new features and components</li>
<li>Fragmentation of work is limited to teams</li>
<li>Continuous deployment is very tough because an entire application needs to be pushed</li>
</ul>
<p>Microservices bring the following benefits to the plate:</p>
<ul>
<li>If the team is big, people can work on chunks of applications</li>
<li>Adaptability is easy for the new developers</li>
<li>Adopting best practices, such as Continuous Integration (CI) and Continuous Delivery (CD)</li>
<li>Easily replaceable software with loosely coupled architecture</li>
</ul>
<h3 id="go-kit-a-package-for-building-microservices">Go Kit, a package for building microservices<a class="headerlink" href="#go-kit-a-package-for-building-microservices" title="Permanent link">&para;</a></h3>
<p>go get github.com/go-kit/kit</p>
<h1 id="10-deplying-our-rest-srevices">10. Deplying Our REST srevices<a class="headerlink" href="#10-deplying-our-rest-srevices" title="Permanent link">&para;</a></h1>
<h3 id="proxy-server">proxy server<a class="headerlink" href="#proxy-server" title="Permanent link">&para;</a></h3>
<p>The benefits of having a proxy server (Nginx):</p>
<ul>
<li>It can act as a load balancer</li>
<li>It can sit in front of cluster of applications and redirect HTTP requests</li>
<li>It can serve a filesystem with a good performance</li>
<li>It streams media very well</li>
</ul>
<h3 id="load-balancing-with-nginx">Load balancing with Nginx<a class="headerlink" href="#load-balancing-with-nginx" title="Permanent link">&para;</a></h3>
<ul>
<li>Round Robin</li>
<li>Least Coonection: send to the server that is currently serving the least number of clients</li>
<li>IP HASH</li>
<li>Least Time: send to the machine with the lowest average latency time</li>
</ul>
<h3 id="rate-limiting-our-rest-api">Rate limiting our REST API<a class="headerlink" href="#rate-limiting-our-rest-api" title="Permanent link">&para;</a></h3>
<p>limit_conn_zone</p>
<h1 id="11-using-an-api-gateway-to-monitor-and-metricize-rest-api">11. Using an API Gateway to Monitor and Metricize REST API<a class="headerlink" href="#11-using-an-api-gateway-to-monitor-and-metricize-rest-api" title="Permanent link">&para;</a></h1>
<p>They are authentication, logging, rate limiting, and so on. The best way to add those features is to use an API gateway.</p>
<h3 id="why-is-an-api-gateway-required">Why is an API gateway required?<a class="headerlink" href="#why-is-an-api-gateway-required" title="Permanent link">&para;</a></h3>
<p>An api gateway is a fine piece of middleware does these things:</p>
<ul>
<li>Loggig</li>
<li>Security</li>
<li>Traffic control</li>
<li>Transformations</li>
</ul>
<h3 id="kong-an-open-source-api-gateway">Kong, an open-source API gateway<a class="headerlink" href="#kong-an-open-source-api-gateway" title="Permanent link">&para;</a></h3>
<p>Kong is a cloud-native, fast, scalable, and distributed Microservice Abstraction Layer (also known as an API Gateway, API Middleware or in some cases Service Mesh). Made available as an open-source project in 2015, its core values are high performance and extensibility.
Combination of OpenResty and Nginx.</p>
<h1 id="12-handling-authentication-for-our-rest-services">12 Handling Authentication for Our REST Services<a class="headerlink" href="#12-handling-authentication-for-our-rest-services" title="Permanent link">&para;</a></h1>
<ul>
<li>session-based authentication</li>
<li>JSON Web Tokens (JWT)</li>
<li>Authentication2(OAuth2)</li>
</ul>
<div class="highlight"><pre><span></span><code>//go get github.com/gorilla/sessions
var store = sessions.NewCookieStore([]byte(&quot;secret_key&quot;))
</code></pre></div>
<h3 id="session-based-authentication">session-based authentication<a class="headerlink" href="#session-based-authentication" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>package main

import (
    &quot;log&quot;
    &quot;net/http&quot;
    &quot;os&quot;
    &quot;time&quot;

    &quot;github.com/gorilla/mux&quot;
    &quot;github.com/gorilla/sessions&quot;
)

// os.Getenv return empty string &quot;&quot; if not exists key
var store = sessions.NewCookieStore([]byte(os.Getenv(&quot;SESSION_SECRET&quot;)))

var users = map[string]string{&quot;naren&quot;: &quot;passme&quot;, &quot;admin&quot;: &quot;password&quot;}

func HealthcheckHandler(w http.ResponseWriter, r *http.Request) {
    session, _ := store.Get(r, &quot;session.id&quot;)
    if (session.Values[&quot;authenticated&quot;] != nil) &amp;&amp; session.Values[&quot;authenticated&quot;] != false {
        w.Write([]byte(time.Now().String()))
    } else {
        http.Error(w, &quot;Forbidden&quot;, http.StatusForbidden)
    }
}

func LoginHandler(w http.ResponseWriter, r *http.Request) {
    session, _ := store.Get(r, &quot;session.id&quot;)
    err := r.ParseForm()
    if err != nil {
        http.Error(w, &quot;pass the data as URL form encoded&quot;, http.StatusBadRequest)
        return
    }
    username := r.PostForm.Get(&quot;username&quot;)
    password := r.PostForm.Get(&quot;password&quot;)

    if originalPassword, ok := users[username]; ok {
        if password == originalPassword {
            session.Values[&quot;authenticated&quot;] = true
            session.Save(r, w) // save to response
        } else {
            http.Error(w, &quot;Invalid credentials&quot;, http.StatusUnauthorized)
            return
        }
    } else {
        http.Error(w, &quot;user is not found&quot;, http.StatusNotFound)
        return
    }
    w.Write([]byte(&quot;Logged In success&quot;))
}

func LogoutHandler(w http.ResponseWriter, r *http.Request) {
    session, _ := store.Get(r, &quot;session.id&quot;)
    session.Values[&quot;authenticated&quot;] = false
    session.Save(r, w)
    w.Write([]byte(&quot;&quot;))
}

func main() {
    r := mux.NewRouter()
    r.HandleFunc(&quot;/login&quot;, LogoutHandler)
    r.HandleFunc(&quot;/health&quot;, HealthcheckHandler)
    r.HandleFunc(&quot;/logout&quot;, LogoutHandler)
    http.Handle(&quot;/&quot;, r)
    srv := &amp;http.Server{
        Handler:      r,
        Addr:         &quot;127.0.0.1:8000&quot;,
        WriteTimeout: 15 * time.Second,
        ReadTimeout:  15 * time.Second,
    }
    log.Fatal(srv.ListenAndServe())

}
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># test py code</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000/login&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="n">cookies</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">cookies</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000/health&quot;</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>
<h3 id="jwt">JWT<a class="headerlink" href="#jwt" title="Permanent link">&para;</a></h3>
<p><img alt="" src="../jwt.png" /></p>
<h3 id="json-web-token-format">Json web token format<a class="headerlink" href="#json-web-token-format" title="Permanent link">&para;</a></h3>
<ul>
<li>Create a JWT header by doing Base64Url encoding on the header JSON.</li>
<li>Create a JWT payload by doing Base64Url encoding on the payload JSON.</li>
<li>Create a signature by encrypting the appended header and payload using a secret key.</li>
<li>JWT string can be obtained by appending the header, payload, and signature.</li>
</ul>
<p>signature = HMACSHA256( base64UrlEncode(header) + &ldquo;.&rdquo; + base64UrlEncode(payload), secret)
tokenString = base64UrlEncode(header) + &ldquo;.&rdquo; + base64UrlEncode(payload) + &ldquo;.&rdquo; + signature</p>
<p>go get github.com/dgrijalva/jwt-go</p>
<h3 id="auth2">Auth2<a class="headerlink" href="#auth2" title="Permanent link">&para;</a></h3>
<p>Authentication is the process of identifying whether a client is genuine or not. When a server authenticates a client, it checks the username/password pair and creates session cookie/JWT.</p>
<p>Authorization is the process of differentiating one client from another after a successful authentication. In cloud services, the resources requested by a client need to be served by checking that the resources belong to that client but not the other client. The permissions and access to resources vary for different clients. For example, the admin has the highest privileges of resources. A normal user&rsquo;s access is limited.</p>
<p>OAuth2 is a protocol for authenticating multiple clients to a service, whereas the JWT is a token format. We need to encode/decode JWT tokens to implement the second stage (dashed lines in the following screenshot) of OAuth 2.</p>
<p><img alt="" src="../oauth2.png" /></p>
<div class="highlight"><pre><span></span><code>package main

import (
    &quot;encoding/json&quot;
    &quot;fmt&quot;
    &quot;log&quot;
    &quot;net/http&quot;
    &quot;os&quot;
    &quot;time&quot;

    jwt &quot;github.com/dgrijalva/jwt-go&quot;
    &quot;github.com/dgrijalva/jwt-go/request&quot;
    &quot;github.com/gorilla/mux&quot;
)

var secretKey = []byte(os.Getenv(&quot;SESSION_SECRET&quot;))

// var secretKey = []byte(&quot;test&quot;)

var users = map[string]string{&quot;naren&quot;: &quot;passme&quot;, &quot;admin&quot;: &quot;password&quot;}

// json response for jwt
type Response struct {
    Token  string `json:&quot;token&quot;`
    Status string `json:&quot;status&quot;`
}

func HealthcheckHandler(w http.ResponseWriter, r *http.Request) {
    tokenString, err := request.HeaderExtractor{&quot;access_token&quot;}.ExtractToken(r)
    token, err := jwt.Parse(tokenString, func(token *jwt.Token) (interface{}, error) {
        // Don&#39;t forget to validate the alg is what you expect:
        if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
            return nil, fmt.Errorf(&quot;Unexpected signing method: %v&quot;, token.Header[&quot;alg&quot;])
        }
        // hmacSampleSecret is a
        return secretKey, nil
    })
    if err != nil {
        w.WriteHeader(http.StatusForbidden)
        w.Write([]byte(&quot;Access Denied; Please check access token&quot;))
        return
    }

    if claims, ok := token.Claims.(jwt.MapClaims); ok &amp;&amp; token.Valid {
        // If token is valid
        response := make(map[string]string)
        // response[&quot;user&quot;] = claims[&quot;username&quot;]
        response[&quot;time&quot;] = time.Now().String()
        response[&quot;user&quot;] = claims[&quot;username&quot;].(string) // claims value is interface, convert to string
        responseJSON, _ := json.Marshal(response)
        w.Write(responseJSON)
    } else {
        w.WriteHeader(http.StatusForbidden)
        w.Write([]byte(err.Error()))
    }
}

// LoginHandler validates the user credentials
func getTokenHandler(w http.ResponseWriter, r *http.Request) {
    err := r.ParseForm()
    if err != nil {
        http.Error(w, &quot;Please pass the data as URL form encoded&quot;, http.StatusBadRequest)
        return
    }
    username := r.PostForm.Get(&quot;username&quot;)
    password := r.PostForm.Get(&quot;password&quot;)
    if originalPassword, ok := users[username]; ok {
        if password == originalPassword {
            // Create a claims map
            claims := jwt.MapClaims{
                &quot;username&quot;:  username,
                &quot;ExpiresAt&quot;: 15000,
                &quot;IssuedAt&quot;:  time.Now().Unix(),
            }
            token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
            tokenString, err := token.SignedString(secretKey)
            if err != nil {
                w.WriteHeader(http.StatusBadGateway)
                w.Write([]byte(err.Error()))
            }
            response := Response{Token: tokenString, Status: &quot;success&quot;}
            responseJSON, _ := json.Marshal(response)
            w.WriteHeader(http.StatusOK)
            w.Header().Set(&quot;Content-Type&quot;, &quot;application/json&quot;)
            w.Write(responseJSON)
        } else {
            http.Error(w, &quot;Invalid Credentials&quot;, http.StatusUnauthorized)
            return
        }
    } else {
        http.Error(w, &quot;User is not found&quot;, http.StatusNotFound)
        return

    }
}
func main() {
    r := mux.NewRouter()
    r.HandleFunc(&quot;/getToken&quot;, getTokenHandler)
    r.HandleFunc(&quot;/healthcheck&quot;, HealthcheckHandler)
    http.Handle(&quot;/&quot;, r)
    srv := &amp;http.Server{
        Handler: r,
        Addr:    &quot;127.0.0.1:8000&quot;,
        // Good practice: enforce timeouts for servers you create!
        WriteTimeout: 15 * time.Second,
        ReadTimeout:  15 * time.Second,
    }
    log.Fatal(srv.ListenAndServe())
}
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>