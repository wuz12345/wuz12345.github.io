
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="wuzhuang">
      
      
        <meta name="author" content="wuzhuang">
      
      
        <link rel="canonical" href="https://wuz12345.github.io/python/fluent_python/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.16">
    
    
      
        <title>《Fluent Python》杂记 - wuzhuang</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1python" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="wuzhuang" class="md-header__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            wuzhuang
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              《Fluent Python》杂记
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="wuzhuang" class="md-nav__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    wuzhuang
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        简介
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        关于
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          LearnGo
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LearnGo" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          LearnGo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnGo/Read/" class="md-nav__link">
        简介
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          LearnC++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LearnC++" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          LearnC++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          模板和泛型编程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="模板和泛型编程" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          模板和泛型编程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/READ/" class="md-nav__link">
        简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/%E7%B1%BB%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        类模板
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/%E6%97%A0%E7%B1%BB%E5%9E%8B%E6%A8%A1%E6%9D%BF%E5%8F%82%E6%95%B0/" class="md-nav__link">
        非类型模板参数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        可变类型模板
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC/" class="md-nav__link">
        拷贝赋值
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Effiective Modern C++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Effiective Modern C++" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Effiective Modern C++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/Effective%20C%2B%2B/Item01/" class="md-nav__link">
        item1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/Effective%20C%2B%2B/Item02/" class="md-nav__link">
        item2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/Effective%20C%2B%2B/Item07/" class="md-nav__link">
        item7
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E5%B7%A6%E5%80%BC%E4%B8%8E%E5%8F%B3%E5%80%BC/" class="md-nav__link">
        左值与右值
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          GDB
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="GDB" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          GDB
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../GDB/gdb%E8%B0%83%E8%AF%95/" class="md-nav__link">
        GDB调试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          LeetCode刷题
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LeetCode刷题" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          LeetCode刷题
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LeetCode%20%E5%88%B7%E9%A2%98/%E7%BA%BF%E6%80%A7%E8%A1%A8/" class="md-nav__link">
        线性表
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          webRTC
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="webRTC" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          webRTC
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../webrtc/FEC/FEC/" class="md-nav__link">
        FEC
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/wuz12345/mynote/edit/master/docs/python/fluent_python.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<blockquote>
<p>Python is a language for consenting adults. —Alan Runyan</p>
</blockquote>
<p>重新看了下 《Fluent Python》，依旧还是很多东西没能消化完。简单记录下吧</p>
<!--more-->

<h1 id="1python">1.Python 数据模型<a class="headerlink" href="#1python" title="Permanent link">&para;</a></h1>
<p>Python data model
可以看下 python 文档关于 data model 的讨论</p>
<h1 id="2">2. 序列构成的数组<a class="headerlink" href="#2" title="Permanent link">&para;</a></h1>
<p>容器序列(存放引用)：list、tuple、collections.deque
扁平序列（存放值）：str、bytes、bytearray、memoryview、array.array</p>
<p>python2.7 列表推导有变量泄露问题，所以推导的临时变量不要和外部重名</p>
<p>python运行原理可视化: <a href="http://www.pythontutor.com">www.pythontutor.com</a></p>
<div class="codehilite"><pre><span></span><code>t = (1, 2, [1,2])
t[2] += [1,2]    # t 变成 (1, 2, [1,2,1,2]) 同时抛出异常，用dis模块查看
# t[2].extend([1,2]) 没问题
</code></pre></div>

<p>尽量不要把可变类型放在 tuple 里;增量赋值不是原子的；
<code>+= *=</code> 对于可变和不可变对象区分对待，不可变对象会生成新对象（str除外,cpython优化过）</p>
<p>python 使用的排序算法 Timsort 是稳定的
内存视图：memoryview:让用户在不复制内容的情况下操作同一个数组的不同切片。</p>
<p>collections.deque 线程安全</p>
<h1 id="3">3 字典和集合<a class="headerlink" href="#3" title="Permanent link">&para;</a></h1>
<p>可散列：如果一个对象是可散列的，在这个对象的生命周期中， 它的散列值是不变的。而且需要实现<code>__hash__</code>,<code>__eq__</code></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">StrKeyDict0</span><span class="p">(</span><span class="n">dict</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;如果一个类继承了dict，然后这个集成类提供了__missing__方法，</span>
<span class="ss">    那么__getitem__找不到键的时候，会自动调用它，而不是抛出Keyerror</span>
<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__missing__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="nf">str</span><span class="p">)</span><span class="err">:</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">如果</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="n">的</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">还找不到就抛出</span><span class="w"> </span><span class="n">KeyError</span><span class="err">，</span><span class="n">没有这句会无限递归</span><span class="w"></span>
<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">KeyError</span><span class="p">(</span><span class="k">key</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="o">[</span><span class="n">str(key)</span><span class="o">]</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="k">default</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="w"></span>
<span class="w">        </span><span class="ow">except</span><span class="w"> </span><span class="nl">KeyError</span><span class="p">:</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">说明</span><span class="w"> </span><span class="n">__missing__</span><span class="w"> </span><span class="n">也失败了</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">default</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__contains__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;这个方法也是必须的，因为继承来的  __contains__ 没有找到也会去掉用__missing__&quot;&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="k">key</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span><span class="w"></span>
</code></pre></div>

<p>dict 变种：</p>
<ul>
<li>collections.OrderedDict: 保持 key 的顺序</li>
<li>collections.ChainMap: 容纳多个不同的映射对象</li>
<li>collections.Counter: 计数器</li>
<li>
<p>collections.UserDict : 其实就是把标准 dict 用纯 python 实习一遍</p>
<p>import UserDict</p>
<p>class StrKeyDict(UserDict):</p>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">__missing__</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">key</span><span class="ss">)</span>:
    <span class="k">if</span> <span class="nv">isinstance</span><span class="ss">(</span><span class="nv">key</span>, <span class="nv">str</span><span class="ss">)</span>:    # 如果 <span class="nv">str</span> 的 <span class="nv">key</span> 还找不到就抛出 <span class="nv">KeyError</span>，没有这句会无限递归
        <span class="nv">raise</span> <span class="nv">KeyError</span><span class="ss">(</span><span class="nv">key</span><span class="ss">)</span>
    <span class="k">return</span> <span class="nv">self</span>[<span class="nv">str</span><span class="ss">(</span><span class="nv">key</span><span class="ss">)</span>]

<span class="nv">def</span> <span class="nv">__setitem__</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">key</span>, <span class="nv">item</span><span class="ss">)</span>:
    <span class="nv">self</span>.<span class="nv">data</span>[<span class="nv">str</span><span class="ss">(</span><span class="nv">key</span><span class="ss">)</span>] <span class="o">=</span> <span class="nv">item</span>

<span class="nv">def</span> <span class="nv">__contains__</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">key</span><span class="ss">)</span>:
    <span class="k">return</span> <span class="nv">str</span><span class="ss">(</span><span class="nv">key</span><span class="ss">)</span> <span class="nv">in</span> <span class="nv">self</span>.<span class="nv">data</span>
</code></pre></div>

</li>
</ul>
<p>不可变映射类型： types.MappingProxyType  (&gt;=python3.3)</p>
<p>不要在迭代字段和set 的同时修改它。可以先迭代获取需要的内容后放到一个新的dict里。
dict 实现是稀疏列表。</p>
<p>dict特点：</p>
<ul>
<li>元素可散列</li>
<li>内存开销大</li>
<li>键查询很快</li>
<li>键次序取决于添加顺序</li>
<li>往字典里添加新键可能会改变已有键的顺序</li>
</ul>
<p>set特点：</p>
<ul>
<li>元素必须可散列</li>
<li>消耗内存</li>
<li>高效判断是否存在一个元素</li>
<li>元素次序取决于添加顺序</li>
<li>往字典里添加新元素可能会改变已有元素的次序</li>
</ul>
<h1 id="4">4 文本和字节序列<a class="headerlink" href="#4" title="Permanent link">&para;</a></h1>
<blockquote>
<p>人类使用文本，计算机使用字节序列</p>
</blockquote>
<p>字符的标识（码位），十进制数字，在unicode 中以4-6个十六进制数字表示
字符的具体表示取决于使用的编码，编码是在码位和字节序列之间转换时使用的算法
编码：码位-&gt; 字节序列
解码：字节序列 -&gt; 码位</p>
<p>Unicode 三明治：我们可以用一个简单的原则处理编码问题： 字节序列-&gt;字符串-&gt;字节序列。就是说程序中应当仅处理字符串，当需要保存到文件系统或者传输的时候，编码为字节序列</p>
<p>BOM：用来标记字节序</p>
<p>UnicodeEncodeError：字符串转成二进制序列。文本转成字节序列时，如果目标编码没有定义某个字符就会抛异常</p>
<p>UnicodeDecodeError: 二进制转成字符串。遇到无法转换的字节序列</p>
<p>chardet 检测文件编码</p>
<p>处理文本：在多系统中运行的代码需要指定打开和写入的编码，不要依赖默认的编码。除非想判断编码，否则不要在二进制模式中打开文本文件。</p>
<p>使用 unicodedata.normalize 函数对 unicode 规范化（标准等价物）。保存文本之前用 normalize(&lsquo;NFC&rsquo;, user_text) 清洗字符串</p>
<p>Unicode 排序：unicode collation algorith, UCA  使用 PyUCA 库。</p>
<p>双模式 API：根据接受的参数是字节序列或字符串自动处理。re 和 os 模块</p>
<p>cpython 16 位窄构建(narrow build)  32 位宽构建 (wild build) sys.maxunicode。窄构建无法处理 U+FFFF 以上码位</p>
<h1 id="5">5 一等函数<a class="headerlink" href="#5" title="Permanent link">&para;</a></h1>
<p>高阶函数（higher-order function): 接受函数作为参数，或者把函数作为结果返回的函数。比如 map,filter,reduce 等（大部分可以被列表推导替代）</p>
<p>匿名函数：lambda 用于创建匿名函数。不过 lambda 定义体中无法赋值，也无法使用 while, try 等python 语句</p>
<p>可调用对象：内置的 callable() 函数判断是否可以调用</p>
<p>用户定义的可调用类型：任何 python 对象只要是先了 <code>__call__</code> 方法都可以表现得像函数</p>
<p>函数内省：使用 inspect 模块提取函数的签名、参数等</p>
<p>python3 函数注解： <code>def clip(text:str, max_len:'int &gt; 0'=80) -&gt; str:</code> 注解会存储在 函数的 <code>__annotations__</code>(一个dict) 属性中。注解对 python 解释器没有任何意义，只是给 IDE、框架、装饰器等工具使用。</p>
<p>支持函数式编程：</p>
<ul>
<li>operator 模块：常用的有 attrgetter、itemgetter、methodcaller</li>
<li>functools 模块：reduce、partial（基于一个函数创建一个新的可调用对象，把原函数的某些参数固定）、dispatch、wraps</li>
</ul>
<h1 id="6">6 使用一等函数实现设计模式<a class="headerlink" href="#6" title="Permanent link">&para;</a></h1>
<p>程序设计语言会影响人们理解问题的出发点。</p>
<p>本章举了两个例子说明动态语言是如何简化设计模式的。（我个人感觉举的例子不是很好吧，有点过度设计的感觉）
之前曾经总结过使用 Python 实现设计模式，感兴趣的可以参考：</p>
<p><a href="http://python-web-guide.readthedocs.io/zh/latest/">http://python-web-guide.readthedocs.io/zh/latest/</a></p>
<h1 id="7">7 函数装饰器和闭包<a class="headerlink" href="#7" title="Permanent link">&para;</a></h1>
<h4 id="_1">装饰器：可调用的对象，其参数是另一个函数。（说白了就是以函数作为参数的函数）两个特性：<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<ul>
<li>能把被装饰的函数替换为其他函数</li>
<li>装饰器在加载模块时立即执行，通常是在导入时（即python加载模块时）。被装饰的函数只有在明确调用时运行</li>
</ul>
<p>装饰器语法糖:</p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">等价于</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decorate</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"></span>
<span class="nv">@decorate</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">target</span><span class="p">()</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;hehe&#39;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<h4 id="_2">闭包:闭包指延伸了作用域的函数，其中包含函数定义体中引用、但是不在定义体中定义的非全局变量。比如被装饰的函数能访问装饰器函数中定义的变量（非全局的）<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<h4 id="_3">自由变量：<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">make_averager</span><span class="p">():</span><span class="w"></span>
<span class="w">    </span><span class="n">series</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">averager</span><span class="p">(</span><span class="n">new_value</span><span class="p">):</span><span class="w"></span>
<span class="w">        </span><span class="c1"># series 在 averager 中叫做自由变量(free variable)，指未在本地作用域中绑定的变量</span><span class="w"></span>
<span class="w">        </span><span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<h4 id="nonlocal">nonlocal 声明：先来看个例子：<a class="headerlink" href="#nonlocal" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">make_averager</span><span class="ss">()</span>:
    <span class="nv">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nv">total</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nv">def</span> <span class="nv">averager</span><span class="ss">(</span><span class="nv">new_value</span><span class="ss">)</span>:
        # 直接运行到这里会报错，<span class="nv">UnboundLocalError</span>，因为对于非可变类型，会隐式创建局部变量 <span class="nv">count</span>，<span class="nv">count</span> 不是自由变量了
        <span class="nv">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nv">total</span> <span class="o">+=</span> <span class="nv">new_value</span>
        <span class="k">return</span> <span class="nv">total</span>
</code></pre></div>

<p>使用 python3 引入的 nonlocal 刻意把变量标记为自由变量。</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">make_averager</span><span class="p">()</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="nf">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">averager</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">nonlocal</span><span class="w"> </span><span class="nf">count</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="n">python2</span><span class="w"> </span><span class="n">可以用</span><span class="w"> </span><span class="o">[</span><span class="n">count</span><span class="o">]</span><span class="w"> </span><span class="n">把需要修改的变量存储为可变对象</span><span class="w"></span>
<span class="w">        </span><span class="nf">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">new_value</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div>

<h4 id="functoolswraps">functools.wraps 装饰器：把相关属性从被装饰函数复制到装饰器函数中<a class="headerlink" href="#functoolswraps" title="Permanent link">&para;</a></h4>
<h4 id="propertyclassmethodstaticmehtodfunctoolslru_cachefunctoolssingledispatch">标准库中的装饰器：property、classmethod、staticmehtod、functools.lru_cache、functools.singledispatch<a class="headerlink" href="#propertyclassmethodstaticmehtodfunctoolslru_cachefunctoolssingledispatch" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="o">-</span> <span class="nv">lru_cache</span>: 采用 <span class="nv">least</span> <span class="nv">recent</span> <span class="nv">used</span> 算法实现的缓存装饰器
<span class="o">-</span> <span class="nv">singledispatch</span>: 为函数提供重载功能。被其装饰的函数会成为泛函数<span class="ss">(</span><span class="nv">generic</span> <span class="nv">function</span><span class="ss">)</span>:根据第一个参数的类型，用不同的方式执行相同操作的一组函数。替代多个 <span class="k">if</span><span class="o">/</span><span class="k">else</span> <span class="nv">isinstance</span> 判断类型执行不同分之
</code></pre></div>

<h4 id="_4">叠放装饰器:<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">下边等价于</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d1</span><span class="p">(</span><span class="n">d2</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="w"></span>
<span class="nv">@d1</span><span class="w"></span>
<span class="nv">@d2</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">f</span><span class="p">()</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<h4 id="_5">参数化装饰器: 创建一个装饰器工厂函数，把参数传给它，返回一个装饰器，然后再把它应用到要装饰的函数上。<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set</span><span class="p">()</span><span class="w">  </span><span class="c1"># &lt;1&gt;</span><span class="w"></span>

<span class="n">def</span><span class="w"> </span><span class="n">register</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">True</span><span class="p">):</span><span class="w">  </span><span class="c1"># &lt;2&gt;    工厂函数</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">decorate</span><span class="p">(</span><span class="k">func</span><span class="p">):</span><span class="w">  </span><span class="c1"># &lt;3&gt;</span><span class="w"></span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;running register(active=</span><span class="si">%s</span><span class="s1">)-&gt;decorate(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="w"></span>
<span class="w">              </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="k">func</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">registry</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="k">func</span><span class="p">)</span><span class="w">  </span><span class="c1"># &lt;5&gt;</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">func</span><span class="w">  </span><span class="c1"># &lt;6&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">decorate</span><span class="w">  </span><span class="c1"># &lt;7&gt;</span><span class="w"></span>

<span class="err">@</span><span class="n">register</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">False</span><span class="p">)</span><span class="w">  </span><span class="c1"># &lt;8&gt;</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">f1</span><span class="p">():</span><span class="w"></span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;running f1()&#39;</span><span class="p">)</span><span class="w"></span>

<span class="err">@</span><span class="n">register</span><span class="p">()</span><span class="w">  </span><span class="c1"># &lt;9&gt;    # 即使没有参数，工厂函数必须写成调用的形式</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">f2</span><span class="p">():</span><span class="w"></span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;running f2()&#39;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<h4 id="class-class-__call__">使用 class 实现装饰器：看上边多重嵌套的装饰器是不是有点不太优雅， 其实复杂的装饰器笔者更喜欢用 class 实现。还记得 <code>__call__</code> 方法吗，改写下上边这个例子<a class="headerlink" href="#class-class-__call__" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="nb">class</span><span class="w"> </span><span class="n">register</span><span class="p">(</span><span class="n">object</span><span class="p">):</span><span class="w"></span>
<span class="w">    </span><span class="n">registry</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">set</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">active</span><span class="p">=</span><span class="n">True</span><span class="p">):</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">active</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">active</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">):</span><span class="w"></span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s">&#39;running register(active=%s)-&gt;decorate(%s)&#39;</span><span class="w"></span>
<span class="w">            </span><span class="c">% (self.active, func))</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">active</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">registry</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">registry</span><span class="p">.</span><span class="n">discard</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">func</span><span class="w"></span>
</code></pre></div>

<h1 id="8">8 对象引用、可变性和垃圾回收<a class="headerlink" href="#8" title="Permanent link">&para;</a></h1>
<h4 id="_6">变量：我们可以把变量理解为对象的标注（便利贴），多个标注就是别名。变量保存的是对象的引用。<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<h4 id="idobj1-idobj2-obj1-is-obj2-obj1-obj2-obj1eqobj2-some_obj-is-none-none-none">比较对象： 判断是同一个对象: id(obj1) == id(obj2)  或者 obj1 is obj2。比较两个对象的值用 obj1 == obj2 (obj1.<strong>eq</strong>(obj2))。你会发现一般我们用 <code>some_obj is None</code> 来判断一个对象是否是 None，说明 None 是个单例对象。<a class="headerlink" href="#idobj1-idobj2-obj1-is-obj2-obj1-obj2-obj1eqobj2-some_obj-is-none-none-none" title="Permanent link">&para;</a></h4>
<h4 id="tupletuple-list-list">元组(tuple)的相对不可变性：元祖的不可变指的是保存的引用不可变(tuple中不可变的是元素的标识)，与引用的对象无关。比如如果元祖的元素是个 list，我们是可以修改这个 list 的。这也会导致有些元祖无法散列<a class="headerlink" href="#tupletuple-list-list" title="Permanent link">&para;</a></h4>
<p>注意 str/bytes/array.array 等单一类型序列是扁平的，它们保存的不是引用，而是在连续内存中保存数据本身(字符、字节和数字)</p>
<h4 id="httpwwwpythontutorcom">默认做浅复制：构造函数或者 [:] 方法默认是浅复制。如果元素都是不可变的，浅复制没有问题。 <a href="http://www.pythontutor.com">http://www.pythontutor.com</a><a class="headerlink" href="#httpwwwpythontutorcom" title="Permanent link">&para;</a></h4>
<h4 id="copydeepcopy-copycopy-__copy__-__deepcopy__">深拷贝: copy.deepcopy 和 copy.copy 能为任意对象做深复制(副本不共享内部对象的引用)和浅复制。我们可以自定义 <code>__copy__()</code> 和 <code>__deepcopy__()</code> 控制拷贝行为<a class="headerlink" href="#copydeepcopy-copycopy-__copy__-__deepcopy__" title="Permanent link">&para;</a></h4>
<h4 id="python-call-by-sharingpython">函数的参数作为引用时：python 唯一支持的传参模式是共享传参（call by sharing），指函数的各个形式参数获得实参中各个引用的副本。也就是说，函数内部的形参是实参的别名。这个方案的结果就是，函数可能会修改作为参数传入的可变对象，但是无法修改那些对象的标识（即不能把一个对象替换成另一个对象）。（笔者觉得这章解释非常好，之前网上一大堆讨论python究竟是值传递还是引用传递的都是不准确的）<a class="headerlink" href="#python-call-by-sharingpython" title="Permanent link">&para;</a></h4>
<h4 id="py-none">不要使用可变类型作为参数的默认值：这个坑写 py 写多的人应该都碰到过。函数默认值在定义函数时计算（通常是加载模块时），因此默认值变成了函数对象的属性。如果默认值是可变对象，而且修改了它的值，后续的函数调用就会受影响。一般我们用 None 作为占位符。<a class="headerlink" href="#py-none" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>def func(l=None):    # 不要写 def func(l=[]):
    # 使用 None 作为占位符（pylint 默认会提示可变类型参数作为默认值，所以俺经常安利用 pylint 检测代码，防范风险）
    l = None or []
</code></pre></div>

<p>所以，一般对于一个函数，要么确认是要修改可变参数，要么返回新的值（使用参数的拷贝），请不要两者同时做。(笔者在小书 web guide 中明确提醒过)</p>
<h4 id="del-del-cpython-__del__">del 和 垃圾回收: del 语句删除名称，而不是对象(删除引用而不是对象）。只有对象变量保存的是对象的最后一个引用的时候，才会被回收。Cpython 中垃圾回收主要使用的是引用计数。不要轻易自定义 <code>__del__</code> 方法，很难用对。<a class="headerlink" href="#del-del-cpython-__del__" title="Permanent link">&para;</a></h4>
<h4 id="weakref">弱引用(weakref)：有时候需要引用对象，而又不让对象存在的时间超过所需时间，经常用在缓存中。弱引用不会增加对象的引用数量，不会妨碍所指的对象被当做垃圾回收<a class="headerlink" href="#weakref" title="Permanent link">&para;</a></h4>
<ul>
<li>WeakValueDictionary: 一种可变映射，值是对象的弱引用。还有 WeakKeyDictionary、WeakSet、finalize。</li>
</ul>
<h4 id="python-cpython">Python 对不可变类型施加的把戏（CPython 实现细节）<a class="headerlink" href="#python-cpython" title="Permanent link">&para;</a></h4>
<ul>
<li>对于元祖 t, t[:] 和 tuple(t) 不会创建副本，返回的是引用（这点和list 不同）。str, bytes 和 frozenset 也有这种行为</li>
</ul>
<h1 id="9-python">9 符合 Python 风格的对象<a class="headerlink" href="#9-python" title="Permanent link">&para;</a></h1>
<p>鸭子类型(duck typing): 只需按照预定行为实现对象所需的方法即可。</p>
<h4 id="repr-str">对象的表示形式: repr() 让开发者理解的方式返回对象的字符串表示。str() 用户理解的方式返回对象的字符串表示<a class="headerlink" href="#repr-str" title="Permanent link">&para;</a></h4>
<h4 id="classmethod-staticmehtod-classmethod-clsstaticmehtod">classmethod 和 staticmehtod: classmethod 定义操作类而不是操作实例的方法，第一个参数是类本身，最常见的用途是定义定义备选构造方法(返回 cls(*))。staticmehtod 方法就是普通函数，只是碰巧在类的定义体中。<a class="headerlink" href="#classmethod-staticmehtod-classmethod-clsstaticmehtod" title="Permanent link">&para;</a></h4>
<h4 id="pythonpython-private-__attr-python-name-mangling">Python的私有属性和『受保护』属性：python没有 private修饰符，可以通过双下划线  <code>__attr</code> 的形式定义，python 的子类会在存储属性名的时候在前面加上一个下划线和类名。这个语言特性成为名称改写（name mangling）。通常受保护的属性使用一个下划线作为前缀，算是一种命名约定，调用者不应该在类外部访问这种属性。<a class="headerlink" href="#pythonpython-private-__attr-python-name-mangling" title="Permanent link">&para;</a></h4>
<p>python 没有访问控制和 java 设计迥然不同，本章最后的杂谈讨论了这两种设计。在 python 中，我们可以先使用公开属性，等需要时再变成特性。</p>
<h4 id="__slots__python__dict____slots__">使用<code>__slots__</code>类属性节省空间：默认情况下，python在各个中名为<code>__dict__</code>的字典存储实力属性，当生成大量对象时字典会消耗大量内存（底层是稀疏数组），通过<code>__slots__</code>类属性，让解释器在元祖而不是字典中存储实例属性，能大大节省内存。(不支持继承)<a class="headerlink" href="#__slots__python__dict____slots__" title="Permanent link">&para;</a></h4>
<ul>
<li>每个子类都需要定义 <code>__slots__</code>，解释器会忽略继承的 <code>__slots__</code>属性</li>
<li>实例只能拥有 <code>__slots__</code> 属性，除非把 <code>__dict__</code> 也加到 <code>__slots__</code> 里（这样就失去了节省内存的功效）</li>
</ul>
<h4 id="python">覆盖类属性：python有个独特的特性，类属性可以为实例属性提供默认值<a class="headerlink" href="#python" title="Permanent link">&para;</a></h4>
<h1 id="10">10 序列的修改、散列和切片<a class="headerlink" href="#10" title="Permanent link">&para;</a></h1>
<h4 id="python_1">协议和鸭子类型: python中我们刻意创建序列类型而无需使用继承，只需实现符合序列协议的方法。<a class="headerlink" href="#python_1" title="Permanent link">&para;</a></h4>
<p>鸭子类型： 在面向对象编程中，协议是非正式的接口，只在文档中定义，在代码中不定义。例如 python 序列协议只需要实现 <code>__lens__</code>  和 <code>__getitem__</code> 两个方法。只关心行为而不关心类型。</p>
<p>我们可以模仿 python 对象的内置方法来编写符合 python 风格的类。（具体的大家还是看下书中的代码示例吧，这一章举得例子不错）</p>
<h1 id="11">11 接口：从协议到抽象基类<a class="headerlink" href="#11" title="Permanent link">&para;</a></h1>
<h4 id="_7">使用猴子补丁在运行时实现协议：<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>运行时修改类或者模块，而不改动源码。可以在运行时让类实现协议</p>
<h4 id="collectionsabc">抽象基类：collections.abc 模块<a class="headerlink" href="#collectionsabc" title="Permanent link">&para;</a></h4>
<ul>
<li>Iterable，Container 和 Sized:：Iterable 通过 <code>__iter__</code> 支持迭代，Container 通过  <code>__contains__</code> 支持 in 操作符, Sized 通过 <code>__len__</code> 支持 len() 函数</li>
<li>Sequence， Mapping and Set ：不可变集合类型</li>
<li>MappingView: 映射方法 .items()，.kesy()，.values() 返回的对象分别是 ItemsView,KeysView 和 ValuesView 实例</li>
<li>Callable 和 Hashable: 主要作用市委内置 isinstance 提供支持，以一种安全的方式判断对象能不能调用或散列。python 提供了callable 内置函数却没有提供 hashable() ，用 isinstance(obj, Hashable) 判断</li>
<li>Iterator</li>
<li>numbers包：Number, Complex，Real，Rational，Integral</li>
</ul>
<h4 id="_8">定义并使用抽象基类<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">abc</span>
<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>    <span class="c1"># py3， py2 中使用  __metaclass__ = abc.ABCMeta</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>    <span class="c1"># 该装饰器应该放在最里层</span>
    <span class="k">def</span> <span class="nf">some_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># 这里可以只有 docstring 省略函数体</span>
        <span class="sd">&quot;&quot;&quot;抽象方法，在抽象基类出现之前抽象方法用 Raise NotImplementedError 语句表明由子类实现&quot;&quot;&quot;</span>
</code></pre></div>

<h4 id="register">使用 register 方法注册虚拟子类:<a class="headerlink" href="#register" title="Permanent link">&para;</a></h4>
<p>在抽象基类上调用 register 方法注册其虚拟子类，issubclass 和 isinstance 都能识别，但是注册的的类不会从抽象基类中继承任何方法和属性。查看虚拟子类的 <code>__mro__</code> 会发现抽象基类不在其中(没继承其属性和方法)</p>
<h4 id="__subclasshook__-__subclasshook__-abcsized"><code>__subclasshook__</code> : 即使不注册，抽象基类也能把一个类识别为虚拟子类。定义 <code>__subclasshook__</code> 方法动态识别子类。参考 abc.Sized 源码<a class="headerlink" href="#__subclasshook__-__subclasshook__-abcsized" title="Permanent link">&para;</a></h4>
<h4 id="_9">强类型和弱类型：<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>如果一门语言很少隐式转换类型，说明它是强类型语言(java/c++/python)。如果经常这么做，是弱类型语言(php,javascript,perl)。强类型能及早发现缺陷</p>
<h4 id="_10">静态和动态类型：<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>在编译时期检查类型的语言是静态语言，运行时检查类型的语言是动态语言。静态类型需要类型声明（有些现代语言使用类型推导避免部分类型声明）。静态类型便于编译器和 IDE
及早分析代码、找出错误和提供其他服务（优化、重构等）。动态类型便于代码重用，代码行数更少，而且能让接口自然成为协议而不提早实行。</p>
<h1 id="12">12 继承的优缺点<a class="headerlink" href="#12" title="Permanent link">&para;</a></h1>
<h4 id="_11">子类化内置类型：<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>内置类型的方法不会调用子类覆盖的方法。不要子类化C语言实现的内置类型（list,dict等），用户自定义的类应该继承自 collections
模块。collections.UserDict, UserList and UserString</p>
<h4 id="_12">多重继承和方法解析顺序<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>任何支持多重继承的语言都要处理潜在的明明冲突问题，菱形继承问题。python  会按照 方法解析顺序MRO(method resolution order)
遍历继承图。类都有一个  <code>__mro__</code> 属性，它的值是一个tuple，按照顺序列出各个超类，直到 object 类。MRO 根据 C3 算法计算</p>
<h4 id="_13">处理多重继承<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>多重继承增加了可选方案和复杂度</p>
<ul>
<li>把接口继承和实现继承区分开。明确一开始为什么创建子类。1.继承接口，创建子类型，实现『是什么』关系。2.继承实现，重用代码。通过继承重用代码是实现细节，通常可换成组合和委托。接口继承是框架的支柱</li>
<li>使用抽象基类显示表示接口</li>
<li>通过 mixin 重用代码。mixin 不定义新类型, 只是打包方法，便于重用。mixin 类绝对不能实例化，应该提供某方面的特定行为，只是实现少量关系非常紧密的方法</li>
<li>明确指名 mixin。类应该以 mixin 后缀</li>
<li>抽象基类可以作为 mixin，但是反过来不成立</li>
<li>
<p>不要子类化多个具体类。具体类的超类中除了一个具体类，其他都应该是抽象基类或者 mixin</p>
<p>class MyConcreteClass(Alpha, Beta, Gamma):
    &ldquo;&rdquo;&rdquo; 如果 Alpha 是具体类，Beta 和 Gamma 必须是抽象基类或者 mixin&rdquo;&ldquo;&rdquo;
    pass</p>
</li>
<li>
<p>创建聚合类。django 中的 ListView，tinker中的 Widget</p>
<p>class Widget(BaseWidget, Pack, Place, Grid):
    pass</p>
</li>
<li>
<p>优先使用组合而非继承。子类化是一种紧耦合，不要过度使用</p>
</li>
</ul>
<h1 id="13">13  正确重载运算符<a class="headerlink" href="#13" title="Permanent link">&para;</a></h1>
<p>python 不允许用户随意创建运算符，禁止重载内置类型的运算符。python支持运算符重载是其在科学计算领域使用广泛的原因。</p>
<ul>
<li>一元运算符：始终返回一个新对象。</li>
<li>
<p>NotImplemented 是个特殊的单例值，如果中缀运算符特殊方法不能处理给定的操作数，要把它返回给解释器。NotImplementedError 是一种异常，抽象类中的方法把它 raise 出，提醒子类必须覆盖。</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span><span class="p">):</span><span class="w"></span>
<span class="w">      </span><span class="n">try</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">pairs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span><span class="p">,</span><span class="w"> </span><span class="n">fillvalue</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Vector</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">pairs</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">except</span><span class="w"> </span><span class="n">TypeError</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="c1"># 返回 NotImplemented 解释器会尝试调用 反向运算符方法 __radd__</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">NotImplemented</span><span class="w"></span>

<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span><span class="p">):</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other</span><span class="w"></span>
</code></pre></div>

</li>
<li>
<p>增量赋值运算符不会修改不可变目标，而是新建实例，然后重新绑定。</p>
</li>
</ul>
<h1 id="14">14 可迭代对象、迭代器和生成器<a class="headerlink" href="#14" title="Permanent link">&para;</a></h1>
<p>解释器需要迭代对象 x 时，会自动调用 iter(x)。内置的 iter 有以下作用：</p>
<ul>
<li>检查对象是否实现了 <code>__iter__</code> ，如果实现了就调用它获取一个迭代器</li>
<li>如果没有实现 <code>__iter__</code> 方法，但是实现了 <code>__getitem__</code> 方法，python 会创建一个迭代器，尝试按照顺序（从索引0）获取元素</li>
<li>如果尝试失败，抛出 TypeError 异常</li>
</ul>
<h4 id="_14">可迭代对象:<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>如果对象实现了能返回迭代器的 <code>__iter__</code> 方法，就是可迭代的。序列都可以迭代；实现了  <code>__getitem__</code> 方法，而且其参数是从 0 开始的索引，这种对象也可以迭代。</p>
<h4 id="_15">标准迭代器接口有两个方法：<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<ul>
<li><code>__next__</code>: 返回下一个可用的元素，没有元素抛出 StopIteration</li>
<li><code>__iter__</code>: 返回 self，以便在应该使用可迭代对象的地方使用迭代器，例如 for 循环中</li>
</ul>
<p>检查对象是否是迭代器的最好方法是调用 isinstance(x, abc.Iterator)</p>
<h4 id="_16">迭代器:<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>实现了无参数的 <code>__next__</code> 方法，返回序列中下一个元素；如果没有元素了，抛出 StopIteration 异常。python中的迭代器还实现了
<code>__iter__</code> 方法，因此迭代器也可以迭代。</p>
<h4 id="_17">二者区别：<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>迭代器可以迭代，但是可迭代的对象不是迭代器。可迭代的对象一定不能是自身的迭代器。也就是说，可迭代对象必须实现  <code>__iter__</code>
，但是不能实现 <code>__next__</code></p>
<h4 id="_18">生成器函数<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>只要 python 的函数体中有 yield 关键字，该函数就是生成器函数。调用生成器函数会返回一个生成器对象。生成器函数是生成器工厂</p>
<h4 id="_19">标准库的中生成器函数<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<ul>
<li>用于过滤的生成器函数: itertools.takewhile/compress/dropwhile/filter/filterfalse/islice/</li>
<li>用于映射的生成器函数: 内置的 enumerate/map  itertools.accumulate/starmap</li>
<li>用于合并的生成器函数：itertools.chain/from_iterable/product/zip_longest  内置的 zip</li>
<li>从一个元素产生多个值，扩展输入的可迭代对象: itertools.combinations/combinations_with_replacement/count/cycle/permutations/repeat</li>
<li>产出输入可迭代对象的全部元素，以某种方式排列：itertools.groupby/tee     内置的 reversed</li>
</ul>
<h4 id="_20">可迭代的规约函数<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<p>归约函数：接受一个可迭代的对象，返回单个结果。all/any/max/mini/functools.reduce/sum    all/any 有短路特性</p>
<h4 id="_21">把生成器当协程<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h4>
<p><code>.send()</code> 方法致使生成器前进到下一个 yield 语句，还允许使用生成器的客户把数据发给自己，不管传给 send 方法什么参数，
那个参数都会成为生成器函数定义体中对应的 yield 表达式的值。</p>
<h1 id="15-else">15 上下文管理器和 else 块<a class="headerlink" href="#15-else" title="Permanent link">&para;</a></h1>
<h4 id="eafp-vs-lbyl">EAFP vs LBYL<a class="headerlink" href="#eafp-vs-lbyl" title="Permanent link">&para;</a></h4>
<ul>
<li>EAFP: easier to ask for forgiveness than permission</li>
<li>LBYL: look before you leap</li>
</ul>
<h4 id="with">上下文管理器和 with 块<a class="headerlink" href="#with" title="Permanent link">&para;</a></h4>
<p>with 语句用来简化 try/finally 模式。经常用在管理事务，维护锁、条件和信号，给对象打补丁等。</p>
<div class="codehilite"><pre><span></span><code><span class="s s-Atom">class</span> <span class="nv">LookingGlass</span><span class="o">:</span>

    <span class="s s-Atom">def</span> <span class="k">__</span><span class="nf">enter__</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">)</span><span class="o">:</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span>
        <span class="s s-Atom">import</span> <span class="s s-Atom">sys</span>
        <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">original_write</span> <span class="o">=</span> <span class="s s-Atom">sys</span><span class="p">.</span><span class="s s-Atom">stdout</span><span class="p">.</span><span class="s s-Atom">write</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span>
        <span class="s s-Atom">sys</span><span class="p">.</span><span class="s s-Atom">stdout</span><span class="p">.</span><span class="s s-Atom">write</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">reverse_write</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span>
        <span class="s s-Atom">return</span> <span class="s s-Atom">&#39;JABBERWOCKY&#39;</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>

    <span class="s s-Atom">def</span> <span class="nf">reverse_write</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">,</span> <span class="s s-Atom">text</span><span class="p">)</span><span class="o">:</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span>
        <span class="s s-Atom">self</span><span class="p">.</span><span class="nf">original_write</span><span class="p">(</span><span class="s s-Atom">text</span><span class="p">[</span><span class="o">::-</span><span class="mi">1</span><span class="p">])</span>

    <span class="s s-Atom">def</span> <span class="k">__</span><span class="nf">exit__</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">,</span> <span class="s s-Atom">exc_type</span><span class="p">,</span> <span class="s s-Atom">exc_value</span><span class="p">,</span> <span class="s s-Atom">traceback</span><span class="p">)</span><span class="o">:</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span>
        <span class="s s-Atom">import</span> <span class="s s-Atom">sys</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">7</span><span class="o">&gt;</span>
        <span class="s s-Atom">sys</span><span class="p">.</span><span class="s s-Atom">stdout</span><span class="p">.</span><span class="s s-Atom">write</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">original_write</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span>
        <span class="s s-Atom">if</span> <span class="s s-Atom">exc_type</span> <span class="o">is</span> <span class="nv">ZeroDivisionError</span><span class="o">:</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">9</span><span class="o">&gt;</span>
            <span class="nf">print</span><span class="p">(</span><span class="s s-Atom">&#39;Please DO NOT divide by zero!&#39;</span><span class="p">)</span>
            <span class="s s-Atom">return</span> <span class="nv">True</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span>
</code></pre></div>

<h4 id="contextlib">contextlib 模块中的实用工具<a class="headerlink" href="#contextlib" title="Permanent link">&para;</a></h4>
<p><code>@contextmanager</code> 装饰器能减少创建上下文管理器的样板代码。只需要实现一个 yield 语句的生成器，生成想让 <code>__enter__</code>
方法返回的值。</p>
<div class="codehilite"><pre><span></span><code><span class="s s-Atom">@contextlib</span><span class="p">.</span><span class="s s-Atom">contextmanager</span>
<span class="s s-Atom">def</span> <span class="nf">looking_glass</span><span class="p">()</span><span class="o">:</span>
    <span class="s s-Atom">import</span> <span class="s s-Atom">sys</span>
    <span class="s s-Atom">original_write</span> <span class="o">=</span> <span class="s s-Atom">sys</span><span class="p">.</span><span class="s s-Atom">stdout</span><span class="p">.</span><span class="s s-Atom">write</span>

    <span class="s s-Atom">def</span> <span class="nf">reverse_write</span><span class="p">(</span><span class="s s-Atom">text</span><span class="p">)</span><span class="o">:</span>
        <span class="nf">original_write</span><span class="p">(</span><span class="s s-Atom">text</span><span class="p">[</span><span class="o">::-</span><span class="mi">1</span><span class="p">])</span>

    <span class="s s-Atom">sys</span><span class="p">.</span><span class="s s-Atom">stdout</span><span class="p">.</span><span class="s s-Atom">write</span> <span class="o">=</span> <span class="s s-Atom">reverse_write</span>
    <span class="s s-Atom">msg</span> <span class="o">=</span> <span class="s s-Atom">&#39;&#39;</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span>
    <span class="s s-Atom">try</span><span class="p">:</span>
        <span class="s s-Atom">yield</span> <span class="s s-Atom">&#39;JABBERWOCKY&#39;</span>  <span class="s s-Atom">#</span> <span class="s s-Atom">产出一个值，这个值会绑定到with语句中的</span> <span class="s s-Atom">as</span> <span class="s s-Atom">子句的目标变量上</span>
    <span class="s s-Atom">except</span> <span class="nv">ZeroDivisionError</span><span class="o">:</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span>
        <span class="s s-Atom">msg</span> <span class="o">=</span> <span class="s s-Atom">&#39;Please DO NOT divide by zero!&#39;</span>
    <span class="s s-Atom">finally</span><span class="p">:</span>
        <span class="s s-Atom">sys</span><span class="p">.</span><span class="s s-Atom">stdout</span><span class="p">.</span><span class="s s-Atom">write</span> <span class="o">=</span> <span class="s s-Atom">original_write</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span>
        <span class="s s-Atom">if</span> <span class="s s-Atom">msg</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="s s-Atom">msg</span><span class="p">)</span>  <span class="s s-Atom">#</span> <span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>
</code></pre></div>

<h1 id="16">16 协程<a class="headerlink" href="#16" title="Permanent link">&para;</a></h1>
<p>句法上看，协程和生成器类似，都是定义体中包含 yield 关键字的函数。但在协程中，yield 通常出现在表达式右边(datum =
yield)，可以产出值，也可以不产出。如果yield 关键字后边没有表达式，那么生成器产出 None。调用方可以用 send
方法把数据提供给协程。从根本上把 yield 视作控制流程的方式。</p>
<h4 id="_22">生成器如何进化成协程<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>python2.5 之后yield 关键在能在表达式中使用，而且生成器 api 中增加了 <code>.send(value)</code> 方法。生成器的调用方可以用 send
发送数据，发送的数据会成为生成器函数中 yield 表达式的值。因此生成器能当做协程使用。协程是指一个过程，这个过程与调用方协作，产出由调用方提供的值。</p>
<p>协程使用 next 函数预激(prime)，即让协程向前执行到第一个 yield 表达式。</p>
<h4 id="prime">预激（prime）协程的装饰器<a class="headerlink" href="#prime" title="Permanent link">&para;</a></h4>
<p>启动协程之前需要 prime，方法是调用 send(None) 或者 next() 。为了简化协程的语法，有时候会使用一个 预激 装饰器。
比如 tornado.gen 装饰器。yield from 调用协程会自动 预激</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">coroutine</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;向前执行到第一个 yield 表达式，预激 func &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">primer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>    <span class="c1"># 获取生成器对象</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>    <span class="c1"># prime</span>
        <span class="k">return</span> <span class="n">gen</span>
    <span class="k">return</span> <span class="n">primer</span>
</code></pre></div>

<h4 id="_23">终止协程和异常处理<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p>协程中未处理的异常会向上冒泡</p>
<ul>
<li>generator.throw(exc_type)</li>
<li>generator.close()</li>
</ul>
<h4 id="_24">让协程返回值<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<p>协程中 return 表达式的值会偷偷传给调用方，赋值给 StopIteration 异常的一个属性 value</p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">coro</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">None</span><span class="o">)</span><span class="w"></span>
<span class="n">except</span><span class="w"> </span><span class="n">StopIteration</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">exc</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exc</span><span class="o">.</span><span class="na">value</span><span class="w"></span>
</code></pre></div>

<h4 id="yield-frompython3">yield from(python3)<a class="headerlink" href="#yield-frompython3" title="Permanent link">&para;</a></h4>
<p>RESULT = yield from EXPR  等效代码如下，比较烧脑， 但是能帮助我们理解 yield from 如何工作</p>
<div class="codehilite"><pre><span></span><code><span class="nv">_i</span> <span class="o">=</span> <span class="nv">iter</span><span class="ss">(</span><span class="nv">EXPR</span><span class="ss">)</span>  # <span class="nv">EXPR</span> 是任何可迭代对象
<span class="nv">try</span>:
    <span class="nv">_y</span> <span class="o">=</span> <span class="k">next</span><span class="ss">(</span><span class="nv">_i</span><span class="ss">)</span>  # 预激<span class="ss">(</span><span class="nv">prime</span><span class="ss">)</span> 子生成器
<span class="nv">except</span> <span class="nv">StopIteration</span> <span class="nv">as</span> <span class="nv">_e</span>:
    <span class="nv">_r</span> <span class="o">=</span> <span class="nv">_e</span>.<span class="nv">value</span>  # 如果抛出 <span class="nv">StopIteration</span> 获取 <span class="nv">value</span> 属性（返回值）
<span class="k">else</span>:
    <span class="k">while</span> <span class="mi">1</span>:  # 运行这个循环时，委派生成器会阻塞，只作为调用方和子生成器之间的通道
        <span class="nv">try</span>:
            <span class="nv">_s</span> <span class="o">=</span> <span class="nv">yield</span> <span class="nv">_y</span>  # 产出字生成器当前产出元素；等待调用方发送 <span class="nv">_s</span> 中保存的值
        <span class="nv">except</span> <span class="nv">GeneratorExit</span> <span class="nv">as</span> <span class="nv">_e</span>:  # 用于关闭委派生成器和子生成器
            <span class="nv">try</span>:
                <span class="nv">_m</span> <span class="o">=</span> <span class="nv">_i</span>.<span class="nv">close</span>
            <span class="nv">except</span> <span class="nv">AttributeError</span>:   # 子生成器是任何可迭代对象，所以可能没有 <span class="nv">close</span> 方法
                <span class="nv">pass</span>
            <span class="k">else</span>:
                <span class="nv">_m</span><span class="ss">()</span>
            <span class="nv">raise</span> <span class="nv">_e</span>
        <span class="nv">except</span> <span class="nv">BaseException</span> <span class="nv">as</span> <span class="nv">_e</span>:  # 处理调用方通过 <span class="nv">throw</span> 方法传入的异常
            <span class="nv">_x</span> <span class="o">=</span> <span class="nv">sys</span>.<span class="nv">exc_info</span><span class="ss">()</span>
            <span class="nv">try</span>:
                <span class="nv">_m</span> <span class="o">=</span> <span class="nv">_i</span>.<span class="nv">throw</span>
            <span class="nv">except</span> <span class="nv">AttributeError</span>:    # 子生成器是任何可迭代对象，所以可能没有 <span class="nv">throw</span> 方法
                <span class="nv">raise</span> <span class="nv">_e</span>
            <span class="k">else</span>:  # 如果子生成器有 <span class="nv">throw</span> 方法，调用它并传入调用方发来的异常
                <span class="nv">try</span>:
                    <span class="nv">_y</span> <span class="o">=</span> <span class="nv">_m</span><span class="ss">(</span><span class="o">*</span><span class="nv">_x</span><span class="ss">)</span>
                <span class="nv">except</span> <span class="nv">StopIteration</span> <span class="nv">as</span> <span class="nv">_e</span>:
                    <span class="nv">_r</span> <span class="o">=</span> <span class="nv">_e</span>.<span class="nv">value</span>
                    <span class="k">break</span>
        <span class="k">else</span>:  # 如果产出值时没有异常
            <span class="nv">try</span>:  尝试让子生成器向前执行
                <span class="k">if</span> <span class="nv">_s</span> <span class="nv">is</span> <span class="nv">None</span>:  # <span class="o">&lt;</span><span class="mi">11</span><span class="o">&gt;</span>
                    <span class="nv">_y</span> <span class="o">=</span> <span class="k">next</span><span class="ss">(</span><span class="nv">_i</span><span class="ss">)</span>
                <span class="k">else</span>:
                    <span class="nv">_y</span> <span class="o">=</span> <span class="nv">_i</span>.<span class="k">send</span><span class="ss">(</span><span class="nv">_s</span><span class="ss">)</span>
            <span class="nv">except</span> <span class="nv">StopIteration</span> <span class="nv">as</span> <span class="nv">_e</span>:  # <span class="o">&lt;</span><span class="mi">12</span><span class="o">&gt;</span>
                <span class="nv">_r</span> <span class="o">=</span> <span class="nv">_e</span>.<span class="nv">value</span>
                <span class="k">break</span>

<span class="nb">RESULT</span> <span class="o">=</span> <span class="nv">_r</span>  # 返回的值是 <span class="nv">_r</span>，即整个 <span class="nv">yield</span> <span class="nv">from</span> 表达式的值
</code></pre></div>

<h1 id="17-concurrentfutures">17 使用 concurrent.futures 处理并发<a class="headerlink" href="#17-concurrentfutures" title="Permanent link">&para;</a></h1>
<p>python3.2 后引入了 concurrent.futers 模块用来处理并发。该模块引入了 TreadPoolExecutor 和 ProcessPoolExecutor
类，这两个类实现的接口能分别在不同的线程和进程中执行可调用的对象。</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>

<span class="kn">from</span> <span class="nn">flags</span> <span class="kn">import</span> <span class="n">save_flag</span><span class="p">,</span> <span class="n">get_flag</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">main</span>  <span class="c1"># &lt;1&gt;</span>

<span class="n">MAX_WORKERS</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># &lt;2&gt;</span>


<span class="k">def</span> <span class="nf">download_one</span><span class="p">(</span><span class="n">cc</span><span class="p">):</span>  <span class="c1"># &lt;3&gt;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
    <span class="n">show</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
    <span class="n">save_flag</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.gif&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cc</span>


<span class="k">def</span> <span class="nf">download_many</span><span class="p">(</span><span class="n">cc_list</span><span class="p">):</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_WORKERS</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc_list</span><span class="p">))</span>  <span class="c1"># &lt;4&gt;</span>
    <span class="k">with</span> <span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>  <span class="c1"># &lt;5&gt;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">download_one</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cc_list</span><span class="p">))</span>  <span class="c1"># &lt;6&gt;</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>  <span class="c1"># &lt;7&gt;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">download_many</span><span class="p">)</span>  <span class="c1"># &lt;8&gt;</span>
</code></pre></div>

<h4 id="future">Future(期物)(中文版翻译感觉这个名字怪怪的)<a class="headerlink" href="#future" title="Permanent link">&para;</a></h4>
<p>concurrent.futures.Future: Feature 类的实例都表示可能已经完成或者尚未完成的延迟计算，可以调用它的 result() 方法获取结果</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">download_many</span><span class="p">(</span><span class="n">cc_list</span><span class="p">):</span><span class="w"></span>
<span class="w">    </span><span class="n">cc_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cc_list</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="w">  </span><span class="c1"># &lt;1&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">executor</span><span class="p">:</span><span class="w">  </span><span class="c1"># &lt;2&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">to_do</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sorted</span><span class="p">(</span><span class="n">cc_list</span><span class="p">):</span><span class="w">  </span><span class="c1"># &lt;3&gt;</span><span class="w"></span>
<span class="w">            </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">download_one</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">)</span><span class="w">  </span><span class="c1"># &lt;4&gt;</span><span class="w"></span>
<span class="w">            </span><span class="n">to_do</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span><span class="w">  </span><span class="c1"># &lt;5&gt;</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Scheduled for {}: {}&#39;</span><span class="w"></span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">future</span><span class="p">))</span><span class="w">  </span><span class="c1"># &lt;6&gt;</span><span class="w"></span>

<span class="w">        </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">to_do</span><span class="p">):</span><span class="w">  </span><span class="c1"># &lt;7&gt;</span><span class="w"></span>
<span class="w">            </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="w">  </span><span class="c1"># &lt;8&gt;</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;{} result: {!r}&#39;</span><span class="w"></span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">future</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="c1"># &lt;9&gt;</span><span class="w"></span>
<span class="w">            </span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<h4 id="io-gil">阻塞型 IO 和 GIL<a class="headerlink" href="#io-gil" title="Permanent link">&para;</a></h4>
<p>GIL 一次只允许一个线程执行 python 字节码。但是标准库中所有执行阻塞型 I/O 操作的函数，在等待操作系统返回的结果时都会释放
GIL，这意味着python 在这个层次上能使用多线程，一个 python 线程等待网络请求时，阻塞型 I/O 会释放(sleep 函数也会)
GIL，运行另一个线程。因此尽管有 GIL，python 线程还是能在 IO 密集型应用中发挥作用。</p>
<h4 id="concurrentfuturesprocesspoolexecutor-gil">concurrent.futures.ProcessPoolExecutor 绕开 GIL<a class="headerlink" href="#concurrentfuturesprocesspoolexecutor-gil" title="Permanent link">&para;</a></h4>
<h1 id="18-asyncio">18 使用 asyncio 处理并发<a class="headerlink" href="#18-asyncio" title="Permanent link">&para;</a></h1>
<h4 id="asyncio">asyncio 使用事件循环驱动的协程实现并发<a class="headerlink" href="#asyncio" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">import</span> <span class="nn">aiohttp</span>  <span class="c1"># &lt;1&gt;</span>

<span class="kn">from</span> <span class="nn">flags</span> <span class="kn">import</span> <span class="n">BASE_URL</span><span class="p">,</span> <span class="n">save_flag</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">main</span>  <span class="c1"># &lt;2&gt;</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>  <span class="c1"># &lt;3&gt;</span>
<span class="k">def</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">cc</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{cc}</span><span class="s1">/</span><span class="si">{cc}</span><span class="s1">.gif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BASE_URL</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>  <span class="c1"># &lt;4&gt;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># &lt;5&gt;</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">download_one</span><span class="p">(</span><span class="n">cc</span><span class="p">):</span>  <span class="c1"># &lt;6&gt;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>  <span class="c1"># &lt;7&gt;</span>
    <span class="n">show</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
    <span class="n">save_flag</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.gif&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cc</span>


<span class="k">def</span> <span class="nf">download_many</span><span class="p">(</span><span class="n">cc_list</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>  <span class="c1"># &lt;8&gt;</span>
    <span class="n">to_do</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_one</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cc_list</span><span class="p">)]</span>  <span class="c1"># &lt;9&gt;</span>
    <span class="n">wait_coro</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">to_do</span><span class="p">)</span>  <span class="c1"># &lt;10&gt;</span>
    <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">wait_coro</span><span class="p">)</span>  <span class="c1"># &lt;11&gt;</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># &lt;12&gt;</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">download_many</span><span class="p">)</span>
</code></pre></div>

<h4 id="_25">避免阻塞型调用<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<p>两种方式避免阻塞型调用中止整个应用程序的进程：</p>
<ul>
<li>在单独的线程中运行各个阻塞型操作(线程内存消耗达到兆字节，取决于操作系统)</li>
<li>把每个阻塞型调用操作转成非阻塞的异步调用</li>
</ul>
<h5 id="asyncio-executor">在 asyncio 中使用 Executor 对象，防止阻塞事件循环<a class="headerlink" href="#asyncio-executor" title="Permanent link">&para;</a></h5>
<p>python 访问本地文件系统会阻塞，硬盘IO 阻塞会浪费几百万个 cpu 周期。解决方法是使用时间循环对象的 run_in_executor 方法。</p>
<div class="codehilite"><pre><span></span><code><span class="err">@</span><span class="n">asyncio</span><span class="o">.</span><span class="n">coroutine</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">download_one</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">base_url</span><span class="p">,</span><span class="w"> </span><span class="n">semaphore</span><span class="p">,</span><span class="w"> </span><span class="n">verbose</span><span class="p">):</span><span class="w"></span>
<span class="w">    </span><span class="n">try</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">with</span><span class="w"> </span><span class="p">(</span><span class="nb">yield</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">semaphore</span><span class="p">):</span><span class="w"></span>
<span class="w">            </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">yield</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">get_flag</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">except</span><span class="w"> </span><span class="n">web</span><span class="o">.</span><span class="n">HTTPNotFound</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">not_found</span><span class="w"></span>
<span class="w">        </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;not found&#39;</span><span class="w"></span>
<span class="w">    </span><span class="n">except</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">exc</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">raise</span><span class="w"> </span><span class="n">FetchError</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">exc</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="w">  </span><span class="c1"># 获取事件循环对象的引用</span><span class="w"></span>
<span class="w">        </span><span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="n">None</span><span class="p">,</span><span class="w">  </span><span class="c1"># None 使用默认的 TrreadPoolExecutor 实例</span><span class="w"></span>
<span class="w">                </span><span class="n">save_flag</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.gif&#39;</span><span class="p">)</span><span class="w">  </span><span class="c1"># 传入可调用对象</span><span class="w"></span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">ok</span><span class="w"></span>
<span class="w">        </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">)</span><span class="w"></span>
<span class="n">asyncio</span><span class="w"> </span><span class="err">的事件循环背后维护一个</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="err">对象，我们可以调用</span><span class="w"> </span><span class="n">run_in_executor</span><span class="w"> </span><span class="err">方法，</span><span class="w"> </span><span class="err">把可调用的对象发给它执行。</span><span class="w"></span>
</code></pre></div>

<h4 id="futures">从回调到 Futures 和 协程<a class="headerlink" href="#futures" title="Permanent link">&para;</a></h4>
<p>回调地狱：如果一个操作需要依赖之前操作的结果，那就得嵌套回调。</p>
<p>python 中的回调地狱：</p>
<div class="codehilite"><pre><span></span><code>def stage1(response1):
    request2 = step1(response1)
    api_call2(request2, stage2)


def stage2(response2):
    request3 = step2(response2)
    api_call3(request3, stage3)


def stage3(response3):
    step3(response3)


api_call1(request1, step1)
</code></pre></div>

<p>使用 协程 和 yield from 结构做异步编程，无需用回调</p>
<div class="codehilite"><pre><span></span><code><span class="nv">@asyncio</span><span class="p">.</span><span class="n">coroutine</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">three_stages</span><span class="p">(</span><span class="n">request1</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="n">response1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yield</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">api_call1</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">request2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">step1</span><span class="p">(</span><span class="n">response1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">response2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yield</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">api_call2</span><span class="p">(</span><span class="n">request2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">request3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">step2</span><span class="p">(</span><span class="n">response2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">response3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yield</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">api_call3</span><span class="p">(</span><span class="n">request3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">step3</span><span class="p">(</span><span class="n">response3</span><span class="p">)</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">协程不能直接调用</span><span class="err">，</span><span class="n">必须用事件循环显示指定协程的执行时间</span><span class="err">，</span><span class="n">或者在其他排定了执行时间的协程中使用</span><span class="w"> </span><span class="n">yield</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">表达式把它激活</span><span class="w"></span>
<span class="n">loop</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">three_stages</span><span class="p">(</span><span class="n">request1</span><span class="p">))</span><span class="w"></span>
</code></pre></div>

<p>何时使用 yield from：基本原则很简单，yield from 只能用于 协程 和 asyncio.Future 实例（包括 Task
实例）。有些肆意混淆了协程和普通函数的 api 比较棘手。</p>
<p>驱动协程：只有驱动协程，协程才能做事，而驱动 asyncio.coroutine 装饰的协程有两种方法，要么使用 yield from，要么传给
asyncio 包中某个参数为协程或者 Futures 的函数，例如 run_until_complete</p>
<h4 id="asyncio_1">使用 asyncio 包编写服务器<a class="headerlink" href="#asyncio_1" title="Permanent link">&para;</a></h4>
<p>可以使用 asyncio 编写 tcp/udp 服务器，使用 aiohttp 编写 web 服务器。具体看各自的文档吧。</p>
<h1 id="19-attributeproperty">19 动态属性(attribute)和特性(property)<a class="headerlink" href="#19-attributeproperty" title="Permanent link">&para;</a></h1>
<p>python 中，数据的属性和处理数据的方法统称为属性（attribute），方法是可调用的属性。特性（property）是不改变类接口的前提下，使用存取方法（读值和设值）修改数据属性。</p>
<p>统一访问原则：不管服务是由存取还是计算实现的，一个模块提供的所有服务都应该统一的方式使用。</p>
<h2 id="_26">使用动态属性转换数据<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h2>
<h4 id="_27">使用动态属性访问数据<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">abc</span>

<span class="k">class</span> <span class="nc">FrozenJSON</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A read-only façade for navigating a JSON-like object</span>
<span class="sd">    using attribute notation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>  <span class="c1"># &lt;1&gt;</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>  <span class="c1"># &lt;2&gt;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>  <span class="c1"># &lt;3&gt;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FrozenJSON</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>  <span class="c1"># &lt;4&gt;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>  <span class="c1"># &lt;5&gt;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>  <span class="c1"># &lt;6&gt;</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">MutableSequence</span><span class="p">):</span>  <span class="c1"># &lt;7&gt;</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &lt;8&gt;</span>
            <span class="k">return</span> <span class="n">obj</span>
</code></pre></div>

<h4 id="_28">处理无效属性名<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">__data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">mapping</span><span class="p">.</span><span class="n">items</span><span class="p">()</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">keyword</span><span class="p">.</span><span class="n">iskeyword</span><span class="p">(</span><span class="k">key</span><span class="p">)</span><span class="err">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">            </span><span class="k">key</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">和</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">重名的关键字加上下划线</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">__data</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">value</span><span class="w"></span>
</code></pre></div>

<h4 id="__new__">使用 <code>__new__</code> 以灵活的方式创建对象<a class="headerlink" href="#__new__" title="Permanent link">&para;</a></h4>
<p>实际上用来构建对象的方法是 <code>__new__</code>，<code>__init__</code> 是初始化方法。<code>__new__</code> 必须返回一个实例，作为 <code>__init__</code>
方法的第一个参数。</p>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">__new__</span><span class="ss">(</span><span class="nv">cls</span>, <span class="nv">arg</span><span class="ss">)</span>:  # <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span>
    <span class="k">if</span> <span class="nv">isinstance</span><span class="ss">(</span><span class="nv">arg</span>, <span class="nv">abc</span>.<span class="nv">Mapping</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">super</span><span class="ss">()</span>.<span class="nv">__new__</span><span class="ss">(</span><span class="nv">cls</span><span class="ss">)</span>  # <span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span>
    <span class="nv">elif</span> <span class="nv">isinstance</span><span class="ss">(</span><span class="nv">arg</span>, <span class="nv">abc</span>.<span class="nv">MutableSequence</span><span class="ss">)</span>:  # <span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span>
        <span class="k">return</span> [<span class="nv">cls</span><span class="ss">(</span><span class="nv">item</span><span class="ss">)</span> <span class="k">for</span> <span class="nv">item</span> <span class="nv">in</span> <span class="nv">arg</span>]
    <span class="k">else</span>:
        <span class="k">return</span> <span class="nv">arg</span>
</code></pre></div>

<h2 id="_29">使用特性验证属性<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nl">LineItem</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">description</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weight</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">price</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">subtotal</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">price</span><span class="w"></span>

<span class="w">    </span><span class="nv">@property</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">weight</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">__weight</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="w"></span>

<span class="w">    </span><span class="nv">@weight</span><span class="p">.</span><span class="n">setter</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">weight</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">__weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">value</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;value must be &gt; 0&#39;</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">7</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>

<h2 id="property">解析 property<a class="headerlink" href="#property" title="Permanent link">&para;</a></h2>
<p>property 签名</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="n">property</span>(<span class="n">fget</span>=<span class="n">None</span>, <span class="n">fset</span>=<span class="n">None</span>, <span class="n">fdel</span>=<span class="n">None</span>, <span class="n">doc</span>=<span class="n">None</span>)
</code></pre></div>

<ul>
<li>特性会覆盖实例属性。特性都是【类属性】，但是特性管理的其实是实例属性的存取。obj.attr 这样的表达式不会从 obj 开始寻找
    attr，而是从 <code>obj.__class__</code> 开始，且仅当类中没有 attr 的属性时， python 才会在 obj 实例中寻找。</li>
</ul>
<h2 id="_30">定义一个特性工厂函数<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">quantity</span><span class="p">(</span><span class="n">storage_name</span><span class="p">)</span><span class="err">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">qty_getter</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="err">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">__dict__</span><span class="o">[</span><span class="n">storage_name</span><span class="o">]</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">qty_setter</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="p">)</span><span class="err">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">instance</span><span class="p">.</span><span class="n">__dict__</span><span class="o">[</span><span class="n">storage_name</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">value</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;value must be &gt; 0&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">property</span><span class="p">(</span><span class="n">qty_getter</span><span class="p">,</span><span class="w"> </span><span class="n">qty_setter</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="w"></span>


<span class="k">class</span><span class="w"> </span><span class="nl">LineItem</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quantity</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quantity</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">description</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weight</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">price</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">subtotal</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">price</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>

<h2 id="_31">处理属性删除操作<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nl">BlackKnight</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">      </span><span class="n">self</span><span class="p">.</span><span class="n">members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">&#39;an arm&#39;, &#39;another arm&#39;,</span>
<span class="n">                      &#39;a leg&#39;, &#39;another leg&#39;</span><span class="o">]</span><span class="w"></span>
<span class="w">      </span><span class="n">self</span><span class="p">.</span><span class="n">phrases</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;&#39;Tis but a scratch.&quot;,</span>
<span class="n">                      &quot;It&#39;s just a flesh wound.&quot;,</span>
<span class="n">                      &quot;I&#39;m invincible!&quot;,</span>
<span class="n">                      &quot;All right, we&#39;ll call it a draw.&quot;</span><span class="o">]</span><span class="w"></span>

<span class="w">  </span><span class="nv">@property</span><span class="w"></span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="k">member</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">      </span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;next member is:&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">members</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">  </span><span class="nv">@member</span><span class="p">.</span><span class="n">deleter</span><span class="w"></span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="k">member</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">      </span><span class="nc">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;BLACK KNIGHT (loses {})\n-- {}&#39;</span><span class="w"></span>
<span class="w">      </span><span class="k">print</span><span class="p">(</span><span class="nc">text</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">members</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">phrases</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"></span>
</code></pre></div>

<h2 id="_32">处理属性的重要属性和函数<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h2>
<h5 id="_33">影响属性处理方式的特殊属性<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h5>
<ul>
<li><code>__class__</code>: 对象所属类的引用。 <code>obj.__class__</code> 与 type(obj) 作用相同。python的某些特殊方法比如
    <code>__getattr__</code>，只在对象的类中寻找，而不在实例中寻找</li>
<li><code>__dict__</code>: 存储对象或者类的可写属性。</li>
<li><code>__slots__</code>: 字符串tuple，限制允许有的属性。</li>
</ul>
<h4 id="_34">处理属性的内置函数<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<ul>
<li>dir: 列出对象的大多数属性</li>
<li>getattr: 从 obj 对象中获取对应名称的属性。获取的属性可能来自对象所属的类或者超类。</li>
<li>hasattr: 判断对象中存在指定的属性</li>
<li>setattr: 创建新属性或者覆盖现有属性</li>
<li>vars： 返回对象的 <code>__dict__</code> 属性</li>
</ul>
<h4 id="_35">处理属性的特殊方法<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h4>
<ul>
<li><code>__delatttr__(self, name)</code> 使用 del 删除属性就会调用这个方法</li>
<li><code>__dir__(self)</code>: 把对象传给 dir 函数时候调用</li>
<li><code>__getattr__</code>: 仅当获取指定的属性失败，搜索过 obj、Class、和超类之后调用</li>
<li><code>__getattribute__</code>: 尝试获取指定的属性时总会调用这个方法，寻找的属性是特殊属性或者特殊方法时候除外。为了防止获取 obj
    的属性无限递归， <code>__getattribute__</code> 方法的实现要使用  <code>super().__getattribute__(obj, name)</code></li>
<li><code>__setattr__</code>: 尝试设置指定的属性总会调用
    # 20 属性描述符</li>
</ul>
<p>描述符是对多个属性运用相同存储逻辑的一种方式。例如 orm 中的字段类型是描述符。描述符是实现了特定协议的类，这个协议包括
<code>__get__ __set__ __delete__</code> 方法。描述符的用法是创建一个实例，作为另一个类的类属性。</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="n">Quantity:</span>  <span class="c1"># &lt;1&gt;</span>

    <span class="n">def</span> <span class="n">__init__</span>(<span class="nb">self</span>, <span class="n">storage_name</span>):
        <span class="nb">self</span>.<span class="n">storage_name</span> = <span class="n">storage_name</span>  <span class="c1"># &lt;2&gt;</span>

    <span class="n">def</span> <span class="n">__set__</span>(<span class="nb">self</span>, <span class="n">instance</span>, <span class="nb">value</span>):  <span class="c1"># &lt;3&gt;</span>
        <span class="k">if</span> <span class="nb">value</span> &gt; <span class="mi">0</span>:
            <span class="n">instance</span>.<span class="n">__dict__</span>[<span class="nb">self</span>.<span class="n">storage_name</span>] = <span class="nb">value</span>  <span class="c1"># &lt;4&gt;</span>
        <span class="n">else:</span>
            <span class="n">raise</span> <span class="n">ValueError</span>(<span class="s">&#39;value must be &gt; 0&#39;</span>)


<span class="k">class</span> <span class="n">LineItem:</span>
    <span class="n">weight</span> = <span class="n">Quantity</span>(<span class="s">&#39;weight&#39;</span>)  <span class="c1"># &lt;5&gt;</span>
    <span class="n">price</span> = <span class="n">Quantity</span>(<span class="s">&#39;price&#39;</span>)  <span class="c1"># &lt;6&gt;</span>

    <span class="n">def</span> <span class="n">__init__</span>(<span class="nb">self</span>, <span class="n">description</span>, <span class="n">weight</span>, <span class="n">price</span>):  <span class="c1"># &lt;7&gt;</span>
        <span class="nb">self</span>.<span class="n">description</span> = <span class="n">description</span>
        <span class="nb">self</span>.<span class="n">weight</span> = <span class="n">weight</span>
        <span class="nb">self</span>.<span class="n">price</span> = <span class="n">price</span>

    <span class="n">def</span> <span class="n">subtotal</span>(<span class="nb">self</span>):
        <span class="k">return</span> <span class="nb">self</span>.<span class="n">weight</span> * <span class="nb">self</span>.<span class="n">price</span>
</code></pre></div>

<p>覆盖型描述符：实现 <code>__set__</code>  方法的描述符属于覆盖型描述符。
非覆盖型描述符：没有实现 <code>__set__</code> 方法的描述符。</p>
<p>方法是描述符</p>
<h4 id="_36">描述符用法建议：<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h4>
<ul>
<li>使用 property 以保持简单: 内置的 property 实现的其实是覆盖型描述符</li>
<li>只读描述符必须有 <code>__set__</code> 方法: 如果使用描述符类实现只读属性， <code>__get__ __set__</code> 两个方法必须定义，否则实例的同名属性会遮盖描述符。只读属性的 <code>__set__</code> 只需抛出 AttributeError 异常，并提供合适的错误消息</li>
<li>用于验证的描述符可以只有 <code>__set__</code></li>
<li>只有 <code>__get__</code> 方法的描述符可以实现高效缓存</li>
<li>非特殊的方法可以被实例属性覆盖</li>
</ul>
<h1 id="21">21 类元编程<a class="headerlink" href="#21" title="Permanent link">&para;</a></h1>
<p>元编程是指在运行时创建或者定制类的技术。除非开发框架，否则不要编写元类
类装饰器能以较为简单的的方式做到需要使用元类去做的事情-创建时定制类。缺点是无法继承</p>
<h4 id="_37">导入时和运行时比较<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h4>
<p>python 中的 import 不只是声明，进程首次导入模块时，还会运行所导入模块中的全部顶层代码。导入时，解释器会执行执行每个类的定义体.
（原书有段代码示例非常好地解释了导入的问题）</p>
<h4 id="_38">元类基础<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h4>
<p>感觉这一章写得不如笔者之前写的一篇博客《简单的python元类》好理解。</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="n">EntityMeta</span>(<span class="nb">type</span>):
    <span class="s">&quot;&quot;&quot;Metaclass for business entities with validated fields&quot;&quot;&quot;</span>

    <span class="n">def</span> <span class="n">__init__</span>(<span class="n">cls</span>, <span class="nb">name</span>, <span class="n">bases</span>, <span class="n">attr_dict</span>):
        <span class="n">super</span>().<span class="n">__init__</span>(<span class="nb">name</span>, <span class="n">bases</span>, <span class="n">attr_dict</span>)  <span class="c1"># &lt;1&gt;</span>
        <span class="k">for</span> <span class="nb">key</span>, <span class="n">attr</span> <span class="nb">in</span> <span class="n">attr_dict</span>.<span class="n">items</span>():  <span class="c1"># &lt;2&gt;</span>
            <span class="k">if</span> <span class="n">isinstance</span>(<span class="n">attr</span>, <span class="n">Validated</span>):
                <span class="n">type_name</span> = <span class="nb">type</span>(<span class="n">attr</span>).<span class="n">__name__</span>
                <span class="n">attr</span>.<span class="n">storage_name</span> = <span class="s">&#39;_{}#{}&#39;</span>.<span class="nb">format</span>(<span class="n">type_name</span>, <span class="nb">key</span>)

<span class="k">class</span> <span class="n">Entity</span>(<span class="n">metaclass</span>=<span class="n">EntityMeta</span>):  <span class="c1"># &lt;3&gt;</span>
    <span class="s">&quot;&quot;&quot;Business entity with validated fields&quot;&quot;&quot;</span>
</code></pre></div>

<h4 id="__prepare__">元类的特殊方法 <code>__prepare__</code><a class="headerlink" href="#__prepare__" title="Permanent link">&para;</a></h4>
<p>某些应用中可能想知道属性定义的顺序，解决办法是使用 python3 引入的 <code>__prepare__</code> 。这个特殊方法只在元类中有用，而且必须是类方法。解释器调用元类的 <code>__new__</code> 之前会先调用 <code>__prepare__</code>，使用类定义体中的属性创建映射。
元类构建新类时， <code>__prepare__</code> 方法返回的映射会传给 <code>__new__</code> 的最后一个参数，然后再传给  <code>__init__</code> 方法。</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">EntityMeta</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;Metaclass for business entities with validated fields&quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="nv">@classmethod</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__prepare__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">bases</span><span class="p">)</span><span class="err">:</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">py3</span><span class="p">,</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="k">method</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">collections</span><span class="p">.</span><span class="n">OrderedDict</span><span class="p">()</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="n">OrderedDict</span><span class="p">,</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">attritubes</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">stored</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">bases</span><span class="p">,</span><span class="w"> </span><span class="n">attr_dict</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">bases</span><span class="p">,</span><span class="w"> </span><span class="n">attr_dict</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">cls</span><span class="p">.</span><span class="n">_field_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">attr_dict</span><span class="p">.</span><span class="n">items</span><span class="p">()</span><span class="err">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">order</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">Validated</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">                </span><span class="nf">type_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">(</span><span class="n">attr</span><span class="p">).</span><span class="n">__name__</span><span class="w"></span>
<span class="w">                </span><span class="n">attr</span><span class="p">.</span><span class="n">storage_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;_{}#{}&#39;</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">type_name</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">cls</span><span class="p">.</span><span class="n">_field_names</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="k">key</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="w"></span>


<span class="k">class</span><span class="w"> </span><span class="n">Entity</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">EntityMeta</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;Business entity with validated fields&quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="nv">@classmethod</span><span class="w"></span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">field_names</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="err">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="nl">_field_names</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">yield</span><span class="w"> </span><span class="n">name</span><span class="w"></span>
</code></pre></div>

<h4 id="_39">元类使用场景<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<ul>
<li>验证属性</li>
<li>一次把装饰器依附到多个方法上</li>
<li>序列化对象或者转换数据</li>
<li>对象关系映射（ORM框架）</li>
<li>基于对象的持久存储</li>
<li>动态转换使用其他语言编写的类结构</li>
</ul>
<h4 id="_40">类作为对象<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h4>
<ul>
<li><code>cls.__bases__</code>: 类的基类组成的元祖</li>
<li><code>cls.__qualname__</code>: py3 引入，值是类或函数的限定名称，即从模块的全局作用域到类的点分路径</li>
<li><code>cls.__subclasses__()</code>： 返回一个list，包含类的直接子类。其实现使用弱引用，防止超类和子类之间出现循环引用。这个方法返回的列表是内存里现存的子类。</li>
<li><code>cls.mro()</code>: 构建类时，如果需要获取存储在类属性 <code>__mro__</code> 中的超类元组，解释器会调用这个方法。元类可以覆盖这个方法。</li>
</ul>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
        <script src="../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>