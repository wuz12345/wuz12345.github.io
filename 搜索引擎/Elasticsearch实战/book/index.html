
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="wuzhuang">
      
      
        <meta name="author" content="wuzhuang">
      
      
        <link rel="canonical" href="https://wuz12345.github.io/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/Elasticsearch%E5%AE%9E%E6%88%98/book/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.16">
    
    
      
        <title>TODO - wuzhuang</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#todo" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="wuzhuang" class="md-header__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            wuzhuang
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              TODO
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="wuzhuang" class="md-nav__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    wuzhuang
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        简介
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        关于
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          LearnC++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LearnC++" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          LearnC++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC/" class="md-nav__link">
        拷贝赋值
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Effiective Modern C++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Effiective Modern C++" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Effiective Modern C++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/Effective%20C%2B%2B/Item01/" class="md-nav__link">
        item1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/Effective%20C%2B%2B/Item02/" class="md-nav__link">
        item2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/Effective%20C%2B%2B/Item07/" class="md-nav__link">
        item7
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnC%2B%2B/%E5%B7%A6%E5%80%BC%E4%B8%8E%E5%8F%B3%E5%80%BC/" class="md-nav__link">
        左值与右值
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          LeetCode刷题
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LeetCode刷题" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          LeetCode刷题
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LeetCode%20%E5%88%B7%E9%A2%98/Zigzag-Conversion/" class="md-nav__link">
        之字形转换
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../LeetCode%20%E5%88%B7%E9%A2%98/%E7%BA%BF%E6%80%A7%E8%A1%A8/" class="md-nav__link">
        线性表
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          有趣的知识
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="有趣的知识" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          有趣的知识
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%9F%A5%E8%AF%86/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8E%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA/" class="md-nav__link">
        正则表达式与有限状态机
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          webRTC
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="webRTC" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          webRTC
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../webrtc/FEC/FEC/" class="md-nav__link">
        FEC
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/wuz12345/mynote/edit/master/docs/搜索引擎/Elasticsearch实战/book.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="todo">TODO<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h1>
<p>构造数据自己实践一下 es 查询。</p>
<h1 id="1-elasticsearch">1. Elasticsearch 介绍<a class="headerlink" href="#1-elasticsearch" title="Permanent link">&para;</a></h1>
<h3 id="_1">解决搜索问题<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>Elasticsearch 建立在 Apache Lucene 之上的开源分布式搜索引擎。
计算文档相关性使用的是 TF-IDF(term frequency-inverse document frequency)</p>
<ul>
<li>词频</li>
<li>逆文档词频: 如果某个单词在所有文档中比较少见，该词权重越高</li>
</ul>
<h3 id="_2">使用案例<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li>作为主要的后端系统。不支持事务</li>
<li>添加到现有系统。保持数据同步</li>
<li>和现有工具一同使用。ELK</li>
</ul>
<h3 id="_3">组织数据<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>Elasticsearch 以文档方式存储数据</p>
<h3 id="_4">安装<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>安装完成之后 打开 <a href="http://localhost:9200">http://localhost:9200</a></p>
<h1 id="2">2. 深入功能<a class="headerlink" href="#2" title="Permanent link">&para;</a></h1>
<ul>
<li>逻辑设计</li>
<li>物理设计。配置决定了集群的性能、可扩展性和可用性</li>
</ul>
<h3 id="_5">文档、类型和索引<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>索引-类型-ID 的组合唯一确定了某篇文档</p>
<p>文档: 自包含，层次型，结构灵活，无模式。</p>
<p>类型：是文档的逻辑容器。不同类型最好放入不同结构的文档 。每个类型中字段的定义称为映射。</p>
<p>索引：是映射类型的容器。索引由一个或多个称为分片的数据块组成</p>
<h1 id="3">3. 索引，更新和删除数据<a class="headerlink" href="#3" title="Permanent link">&para;</a></h1>
<p>核心类型：字符串；数值；日期(默认解析ISO 8601)；布尔</p>
<p>字符串如果索引类型是 analyzed，会转化为小写并且分词。</p>
<h3 id="35">3.5 更新数据<a class="headerlink" href="#35" title="Permanent link">&para;</a></h3>
<p>更新文档包括:</p>
<ul>
<li>检索现有文档。必须打开 <code>_source</code></li>
<li>进行指定的修改</li>
<li>删除旧的文档，在其原有位置索引新的文档</li>
</ul>
<p>使用更新 API:</p>
<ul>
<li>发送部分文档</li>
</ul>
<div class="highlight"><pre><span></span><code>curl -XPOST <span class="s1">&#39;localhost:9200/get-together/group/2/_update&#39;</span> -d <span class="s1">&#39;{</span>
<span class="s1">　&quot;doc&quot;: {</span>
<span class="s1">　　&quot;organizer&quot;: &quot;Roy&quot;</span>
<span class="s1">　}</span>
<span class="s1">}&#39;</span>
</code></pre></div>
<ul>
<li>使用 upsert 创建不存在的文档。默认脚本语言是 Groovy</li>
</ul>
<p>ES 通过 version 乐观锁来进行并发更新的控制：</p>
<ul>
<li>冲突发生的时候可以使用重试操作。retry_on_conflict 参数可以让 es 自动重试</li>
<li>索引文档的时候使用版本号</li>
</ul>
<h3 id="36">3.6 删除数据<a class="headerlink" href="#36" title="Permanent link">&para;</a></h3>
<ul>
<li>通过 id 删除单个文档</li>
<li>单个请求删除多个文档</li>
<li>删除映射类型，包括其中的文档</li>
<li>删除匹配某个查询的所有文档</li>
</ul>
<p>删除索引。</p>
<p>除了删除索引还可以关闭。 <code>curl -XPOST 'localhost:9200/online-shop/_close'</code></p>
<h1 id="4">4 搜索数据<a class="headerlink" href="#4" title="Permanent link">&para;</a></h1>
<p>确定搜索范围，尽量限制在最小范围和类型，增加响应速度。</p>
<p>请求搜索的基本模块：</p>
<ul>
<li>query。使用查询 DSL和过滤 DSL 配置</li>
<li>size: 返回文档数量</li>
<li>from：分页</li>
<li>_source: 指定_source 字段如何返回</li>
<li>sort: 默认排序基于文档得分。sort 可以额外控制</li>
</ul>
<div class="highlight"><pre><span></span><code>curl <span class="s1">&#39;localhost:9200/get-together/group/_search&#39;</span> -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">  &quot;query&quot;: {</span>
<span class="s1">    &quot;match_all&quot;: {}</span>
<span class="s1">  },</span>
<span class="s1">  &quot;from&quot; 0,</span>
<span class="s1">  &quot;size&quot;: 10,</span>
<span class="s1">  &quot;_source&quot;: [&quot;name&quot;, &quot;organizer&quot;],</span>
<span class="s1">  &quot;sort&quot;: [&quot;created_on&quot;: &quot;desc&quot;]</span>
<span class="s1">}&#39;</span>
</code></pre></div>
<h3 id="42-dsl">4.2 查询和过滤 DSL<a class="headerlink" href="#42-dsl" title="Permanent link">&para;</a></h3>
<p>由于不计算得分，过滤器处理更少，并且可以被缓存。</p>
<div class="highlight"><pre><span></span><code>curl <span class="s1">&#39;localhost:9200/get-together/_search&#39;</span> -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">  &quot;query&quot;: {</span>
<span class="s1">    &quot;filtered&quot;: {</span>
<span class="s1">      &quot;query&quot; {</span>
<span class="s1">        &quot;match&quot;: {</span>
<span class="s1">          &quot;title&quot;: &quot;hadoop&quot;</span>
<span class="s1">        }</span>
<span class="s1">      }</span>
<span class="s1">    }</span>
<span class="s1">  },</span>
<span class="s1">  &quot;filter&quot;: {</span>
<span class="s1">    &quot;term&quot;: {</span>
<span class="s1">      &quot;host&quot;: &quot;andy&quot;</span>
<span class="s1">    }</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</code></pre></div>
<ul>
<li>match_all 查询</li>
<li>query_string 查询</li>
<li>term 查询和 term 过滤器</li>
<li>terms 查询，搜索某个文档那个字段中的多个词条</li>
<li>match 查询和 term 过滤器</li>
<li>phrase_prefix 查询，词组中最后一个词条进行前缀匹配。对于提供搜索框里的自动完成功能很有用，输入词条就可以提示。最好用
  max_expansions 限制最大的前缀扩展数量</li>
<li>multiple_match: 可以搜索多个字段中的值</li>
</ul>
<h3 id="43">4.3 组合查询或者复合查询<a class="headerlink" href="#43" title="Permanent link">&para;</a></h3>
<ul>
<li>bool 查询:允许在单独的查询组合任意数量的查询，指定的查询子句表名哪些部分是 must/should/must_not</li>
</ul>
<h3 id="44-match">4.4 超越 match 和过滤器查询<a class="headerlink" href="#44-match" title="Permanent link">&para;</a></h3>
<p>范围查询：</p>
<div class="highlight"><pre><span></span><code>curl <span class="s1">&#39;localhost:9200/get-together/_search&#39;</span> -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">  &quot;query&quot;: {</span>
<span class="s1">    &quot;range&quot;: {</span>
<span class="s1">      &quot;created_on&quot;: {</span>
<span class="s1">        &quot;gt&quot;: &quot;2011-06-01&quot;,</span>
<span class="s1">        &quot;lt&quot;: &quot;2012-06-01&quot;</span>
<span class="s1">      }</span>
<span class="s1">    }</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</code></pre></div>
<p>前缀查询：(如果需要可以先转成小写)</p>
<div class="highlight"><pre><span></span><code>curl <span class="s1">&#39;localhost:9200/get-together/_search&#39;</span> -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">  &quot;query&quot;: {</span>
<span class="s1">      &quot;prefix&quot;: {</span>
<span class="s1">        &quot;title&quot;: &quot;liber&quot;</span>
<span class="s1">      }</span>
<span class="s1">    }</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</code></pre></div>
<p>wildcard 查询: 类似 shell globbing 的工作方式</p>
<h3 id="45">4.5 使用过滤器查询字段的存在性<a class="headerlink" href="#45" title="Permanent link">&para;</a></h3>
<ul>
<li>exists 过滤器</li>
<li>missing 过滤器</li>
</ul>
<h3 id="46">4.6 为任务选择最好的查询<a class="headerlink" href="#46" title="Permanent link">&para;</a></h3>
<p><img alt="" src="../%E6%9F%A5%E8%AF%A2%E9%80%89%E6%8B%A9.png" /></p>
<h1 id="5">5. 分析数据<a class="headerlink" href="#5" title="Permanent link">&para;</a></h1>
<p>什么是分析： 文档被发送并加入到倒排索引之前，es 对其进行的操作。</p>
<ul>
<li>字符过滤：字符过滤器转变字符</li>
<li>文本切分为分词</li>
<li>分词过滤：分词过滤器转变每个分词</li>
<li>分词索引：分词存储到索引中</li>
</ul>
<p>为文档使用分析器：</p>
<ul>
<li>创建索引的时候，为特定的索引进行设置</li>
<li>在 es 配置文件设置全局分析器</li>
</ul>
<h3 id="53-api">5.3 使用分析 API 来分析文本<a class="headerlink" href="#53-api" title="Permanent link">&para;</a></h3>
<p>向 es 发送任何文本，然后指定使用的分析器、分词器、或者分词过滤器，然后获取分析的分词。</p>
<h3 id="54">5.4 分析器、分词器和分词过滤器<a class="headerlink" href="#54" title="Permanent link">&para;</a></h3>
<p>内置分析器：</p>
<p>标准分析器、简单分析器、空白分析器、停用词分析器、关键词分析器、模式分析器、语言和多语言分析器、雪球分析器</p>
<p>分词器：</p>
<p>标准分词器、关键词分词器、字母分词器、小写分词器、空白分词器、模式分词器、UAX URL 电子邮件分词器、路径层次分词器</p>
<p>分词过滤器(接收从分词器出来的分词，然后为索引数据做准):</p>
<p>标准分词过滤器、小写分词器过滤器、长度分词过滤器(限定长度)、停用词分词过滤器
截断分词过滤器、修剪分词过滤器和限制分词过滤器，颠倒分词过滤器、唯一分词过滤器、ASCII 折叠分词过滤器、同义词分词过滤器</p>
<h3 id="55-n-n">5.5 N 元语侧边 N 元语法和滑动窗口<a class="headerlink" href="#55-n-n" title="Permanent link">&para;</a></h3>
<p>n 元语法：将一个单词切分多个子单词</p>
<p>侧边：每个分词都从最前端开始构建</p>
<h3 id="56">5.6 提取词干<a class="headerlink" href="#56" title="Permanent link">&para;</a></h3>
<p>单词缩减到基本或者词根。</p>
<h1 id="6">6 使用相关性进行搜索<a class="headerlink" href="#6" title="Permanent link">&para;</a></h1>
<h3 id="61">6.1 文档打分如何运作<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<p>Lucene 的打分机制是一个公式，将考量的文档作为输入，使用不同的因素来确定该文档得分(score)。
词频(Term-frequency), 逆文档词频(IDF，次数越多越不重要）</p>
<p>TF-IDF 公式计算得分</p>
<h3 id="62">6.2 其他打分方法<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<ul>
<li>Okapi BM25;</li>
<li>DFR 相似度</li>
<li>IB(Information based)相似度</li>
<li>LM Dirichlet 相似度</li>
<li>LM Jelinek Mercer 相似度</li>
</ul>
<p>需要一个良好的测试框架评估算法的变化。</p>
<h3 id="63-boosting">6.3 boosting<a class="headerlink" href="#63-boosting" title="Permanent link">&para;</a></h3>
<p>boosting 是一个可以用来修改文档相关性的程序，可以在查询或者索引期间修改(不推荐)。
考虑 boost 的相对值， name boost 3 倍意味着 name 字段的重要性大概是其他字段 3 倍。</p>
<h3 id="64-explain">6.4 使用 explain 理解文档是被如何评分的<a class="headerlink" href="#64-explain" title="Permanent link">&para;</a></h3>
<p>explain=true。可以查看为什么一个文档和某个查询没有被匹配，有性能开销，不要在生产环境使用。</p>
<div class="highlight"><pre><span></span><code>curl -XPOST <span class="s1">&#39;localhost:9200/get-together/_search?pretty&#39;</span> -d <span class="err">&#39;</span><span class="o">{</span>
　<span class="s2">&quot;query&quot;</span>: <span class="o">{</span>
　　<span class="s2">&quot;match&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;elasticsearch&quot;</span>
    <span class="o">}</span>
　<span class="o">}</span>,
  <span class="s2">&quot;explain&quot;</span>: <span class="nb">true</span>
<span class="o">}</span>
</code></pre></div>
<h3 id="65">6.5 使用查询打分来减小评分操作的性能影响<a class="headerlink" href="#65" title="Permanent link">&para;</a></h3>
<p>下列情况可能导致打分变成资源密集操作：</p>
<ul>
<li>使用脚本的评分
= 进行 phrase 词组陈哈训，搜索一定距离出现的词，使用很大的 slop 值</li>
</ul>
<p>可以使用再打分(rescoring)针对返回结果进行第二轮得分计算。</p>
<h3 id="66-function_score">6.6 使用 function_score 定制得分<a class="headerlink" href="#66-function_score" title="Permanent link">&para;</a></h3>
<p>function_score 允许用户指定任何数量的任意函数，让它们作用于匹配了初始查询的文档，
修改其得分，从而到达精细化控制结果相关性的目的。</p>
<ul>
<li>weight 函数：得分乘以一个常数</li>
</ul>
<h3 id="68">6.8 使用脚本排序<a class="headerlink" href="#68" title="Permanent link">&para;</a></h3>
<p>es 还允许使用脚本在文档返回前对其进行排序，当用户需要在某个不存在的文档字段上排序时非常有用。</p>
<h3 id="69">6.9 字段数据<a class="headerlink" href="#69" title="Permanent link">&para;</a></h3>
<p>需要在某个字段上进行排序或返回一些聚集时，es 需要快速决定，对于每个匹配的文档而言，哪些词条是用于排序或者聚集的。</p>
<h1 id="7-aggregation">7. 使用聚集(aggregation)来探索数据<a class="headerlink" href="#7-aggregation" title="Permanent link">&para;</a></h1>
<p>获取文档的统计数据。</p>
<ul>
<li>度量型(metrics): 一组文档的统计分析，可以得到诸如最小值，最大值，标准差等度量值。</li>
<li>桶(bucket):将匹配的文档切分为一个或多个容器（桶），然后告诉你每个桶里的文档数量</li>
</ul>
<h3 id="71">7.1 理解聚集的结构<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<h3 id="72">7.2 度量聚集<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<p>单独统计：</p>
<div class="highlight"><pre><span></span><code><span class="nv">URI</span> <span class="o">=</span> localhost:9200/get-together/event/_search
curl <span class="s2">&quot;</span><span class="nv">$URI</span><span class="s2">?pretty&amp;search_type=count&quot;</span> -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;aggregations&quot;: {</span>
<span class="s1">        &quot;attendees_avg&quot;: {</span>
<span class="s1">            &quot;avg&quot;: {</span>
<span class="s1">                &quot;script&quot;: &quot;doc[&#39;</span><span class="s2">&quot;&#39;attendees&#39;&quot;</span><span class="s1">&#39;].values.length&quot;</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}&#39;</span>
</code></pre></div>
<p>高级统计：extended_stats，获取平方值、方差和标准差。根据文档统计的，具有 100% 准确性
(注意你的需求是精确统计还是近似统计，近似统计可以限制内存和 cpu 使用。)</p>
<p>近似统计：</p>
<ul>
<li>百分位。可以发现所有值中的 x% 比这个值低。比如看看大多数购物车在哪个价格区间</li>
<li>基数(cardinality)：某个字段中唯一值的数量。比如获取访问某站点的唯一 IP 地址数量</li>
</ul>
<h3 id="73">7.3 多桶型聚集<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<ul>
<li>词条聚集(terms aggregation): 文档中某个词条频率。发现搜索场景中有意义的词</li>
<li>范围聚集：根据文档落入哪些数值、日期、或者 ip 地址范围创建不同的桶。分析固定期望数据</li>
<li>直方图聚集：定义间距值</li>
<li>嵌套聚集、反嵌套聚集、子聚集：针对文档关系执行聚集</li>
<li>地理距离聚集和地理散列格聚集：根据地理位置创建桶</li>
</ul>
<h1 id="8">8. 文档间的关系<a class="headerlink" href="#8" title="Permanent link">&para;</a></h1>
<p>一般像是日志这种文档之间没有什么关系，但是有些文档之间有一定的关系，
比如对象类型、嵌套文档、父子关系和反规范化。</p>
<h3 id="81">8.1 定义关系<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<ul>
<li>对象类型：允许一个对象作为文档字段的值(通常用来处理一对一关系)</li>
<li>嵌套：将地址保存在单独的 Lucene 文档中</li>
<li>父子关系：为不同数据类型使用完全独立的 es 文档</li>
<li>反规范化：对数据进行复制，达到表示关系的目的。可以表达多对多关系</li>
<li>应用端的连接：当数据少，并且可以承受规范化的开销时，可以很好运作</li>
</ul>
<h3 id="82">8.2 将对象作为字段值(适合一对一关系)<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>curl -XPOST <span class="s1">&#39;localhost:9200/get-together/event-object/1&#39;</span> -d <span class="err">&#39;</span><span class="o">{</span>
    <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;title&quot;</span>,
    <span class="s2">&quot;location&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;name&quot;</span> <span class="s2">&quot;name&quot;</span>,
        <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;chapter 8&quot;</span>
    <span class="o">}</span>
<span class="o">}</span><span class="sb">`</span>
</code></pre></div>
<p>es 会进行扁平化处理， location.name 这种形式。</p>
<p>不足：</p>
<ul>
<li>对象之间没有边界</li>
<li>更新一个单独的对象需要索引整个文档</li>
</ul>
<h3 id="83">8.3 嵌套类型<a class="headerlink" href="#83" title="Permanent link">&para;</a></h3>
<p>嵌套映射看起来和对象文档差不多，但是需要使用 type 为 nested 而不是 object。 底层使用分块实现。</p>
<h3 id="84">8.4 父子关系：关联分隔的文档(一对多)<a class="headerlink" href="#84" title="Permanent link">&para;</a></h3>
<p>某个类型定义为同索引中另一个类型的子辈，用于需要经常更新文档或其间关系的时候。</p>
<p>嵌套和父子结构对于一对多的关系来说非常好用。</p>
<h3 id="85">8.5 反规范化：使用冗余的数据管理（多对多）<a class="headerlink" href="#85" title="Permanent link">&para;</a></h3>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>