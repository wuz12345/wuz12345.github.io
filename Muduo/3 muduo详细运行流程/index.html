
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="wuzhuang">
      
      
        <meta name="author" content="wuzhuang">
      
      
        <link rel="canonical" href="https://wuz12345.github.io/Muduo/3%20muduo%E8%AF%A6%E7%BB%86%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.16">
    
    
      
        <title>3 muduo详细运行流程 - wuzhuang</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#muduo" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="wuzhuang" class="md-header__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            wuzhuang
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3 muduo详细运行流程
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="wuzhuang" class="md-nav__button md-logo" aria-label="wuzhuang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    wuzhuang
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wuz12345/mynote/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        简介
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        关于
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          LearnGo
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LearnGo" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          LearnGo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnGo/Read/" class="md-nav__link">
        简介
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          LearnC++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LearnC++" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          LearnC++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          模板和泛型编程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="模板和泛型编程" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          模板和泛型编程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/READ/" class="md-nav__link">
        简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/%E7%B1%BB%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        类模板
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/%E6%97%A0%E7%B1%BB%E5%9E%8B%E6%A8%A1%E6%9D%BF%E5%8F%82%E6%95%B0/" class="md-nav__link">
        非类型模板参数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%A8%A1%E7%89%88%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B/%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        可变类型模板
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC/" class="md-nav__link">
        拷贝赋值
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Effiective Modern C++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Effiective Modern C++" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Effiective Modern C++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/Effective%20C%2B%2B/Item01/" class="md-nav__link">
        item1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/Effective%20C%2B%2B/Item02/" class="md-nav__link">
        item2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/Effective%20C%2B%2B/Item07/" class="md-nav__link">
        item7
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnC%2B%2B/%E5%B7%A6%E5%80%BC%E4%B8%8E%E5%8F%B3%E5%80%BC/" class="md-nav__link">
        左值与右值
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          LeetCode刷题
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LeetCode刷题" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          LeetCode刷题
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LeetCode%20%E5%88%B7%E9%A2%98/%E7%BA%BF%E6%80%A7%E8%A1%A8/" class="md-nav__link">
        线性表
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          webRTC
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="webRTC" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          webRTC
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../webrtc/FEC/FEC/" class="md-nav__link">
        FEC
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#muduo" class="md-nav__link">
    模拟单线程情况下muduo库的工作情况
  </a>
  
    <nav class="md-nav" aria-label="模拟单线程情况下muduo库的工作情况">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#loop" class="md-nav__link">
    监听套接字加入loop循环的完整过程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    一个新连接到达时的处理过程。
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#muduo_1" class="md-nav__link">
    模拟单线程情况下muduo库的工作情况
  </a>
  
    <nav class="md-nav" aria-label="模拟单线程情况下muduo库的工作情况">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-0" class="md-nav__link">
    连接套接字正常情况下完整的销毁情况（read == 0）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#channeltcpconnection" class="md-nav__link">
    Channel与TcpConnection对象的创建与销毁
  </a>
  
    <nav class="md-nav" aria-label="Channel与TcpConnection对象的创建与销毁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    创建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    销毁
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/wuz12345/mynote/edit/master/docs/Muduo/3 muduo详细运行流程.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>3 muduo详细运行流程</h1>

<h2 id="muduo">模拟单线程情况下muduo库的工作情况<a class="headerlink" href="#muduo" title="Permanent link">&para;</a></h2>
<p>muduo的源代码对于一个初学者来说还是有一些复杂的，其中有很多的回调函数以及交叉的组件，下面我将追踪一次TCP连接过程中发生的事情，不会出现用户态的源码，都是库内部的运行机制。下文笔者将描述一次连接发生的过程，将Channel到加入到loop循环为止。</p>
<h3 id="loop">监听套接字加入loop循环的完整过程<a class="headerlink" href="#loop" title="Permanent link">&para;</a></h3>
<ul>
<li>首先创建一个TcpServer对象，在的创建过程中，首先new出来自己的核心组件（Acceptor,loop,connectionMap,threadPool）之后TcpServer会向Acceptor注册一个新连接到来时的Connection回调函数。loop是由用户提供的，并且在最后向Acceptor注册一个回调对象，用于处理：一个新的Client连接到来时该怎么处理。
  TcpServer向Acceptor注册的回调代码主要作用是：当一个新的连接到来时，根据Acceptor创建的可连接描述符和客户的地址，创建一个Connection对象，并且将这个对象加入到TcpServer的ConnectionMap中，由TcpServer来管理上述新建con对象。但是现在监听套接字的事件分发对象Channel还没有加入loop，就先不多提这个新的连接到到来时的处理过程。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">TcpServer</span><span class="o">::</span><span class="n">TcpServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span><span class="w"> </span><span class="n">loop</span><span class="p">,</span><span class="k">const</span><span class="w"> </span><span class="n">InetAddress</span><span class="o">&amp;</span><span class="w"> </span><span class="n">listenAddr</span><span class="p">,</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">nameArg</span><span class="p">,</span><span class="n">Option</span><span class="w"> </span><span class="n">option</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">loop_</span><span class="p">(</span><span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">loop</span><span class="p">)),</span><span class="w"></span>
<span class="w">      </span><span class="n">ipPort_</span><span class="p">(</span><span class="n">listenAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">()),</span><span class="n">name_</span><span class="p">(</span><span class="n">nameArg</span><span class="p">),</span><span class="n">acceptor_</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Acceptor</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="n">listenAddr</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kReusePort</span><span class="p">)),</span><span class="w"></span>
<span class="w">    </span><span class="n">threadPool_</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">EventLoopThreadPool</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="n">name_</span><span class="p">)),</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionCallback_</span><span class="p">(</span><span class="n">defaultConnectionCallback</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">messageCallback_</span><span class="p">(</span><span class="n">defaultMessageCallback</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">nextConnId_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="c1">//上面的loop是用户提供的loop</span>
<span class="w">  </span><span class="n">acceptor_</span><span class="o">-&gt;</span><span class="n">setNewConnectionCallback</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">,</span><span class="w"> </span><span class="n">_2</span><span class="p">));</span><span class="c1">//注册给acceptor的回调</span>
<span class="p">}</span><span class="c1">//将在Acceptor接受新连接的时候</span>

<span class="kt">void</span><span class="w"> </span><span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">InetAddress</span><span class="o">&amp;</span><span class="w"> </span><span class="n">peerAddr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="c1">//将本函数注册个acceptor</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//断言是否在IO线程</span>
<span class="w">  </span><span class="n">EventLoop</span><span class="o">*</span><span class="w"> </span><span class="n">ioLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadPool_</span><span class="o">-&gt;</span><span class="n">getNextLoop</span><span class="p">();</span><span class="c1">//获得线程池中的一个loop</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span><span class="c1">//获得线程池map中的string索引</span>
<span class="w">  </span><span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-%s#%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ipPort_</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">nextConnId_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="o">++</span><span class="n">nextConnId_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">string</span><span class="w"> </span><span class="n">connName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">LOG_INFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;TcpServer::newConnection [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name_</span><span class="w"></span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] - new connection [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">connName</span><span class="w"></span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] from &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">peerAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">InetAddress</span><span class="w"> </span><span class="nf">localAddr</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">getLocalAddr</span><span class="p">(</span><span class="n">sockfd</span><span class="p">));</span><span class="c1">//获得本地的地址，用于构建Connection</span>
<span class="w">  </span><span class="c1">// FIXME poll with zero timeout to double confirm the new connection</span>
<span class="w">  </span><span class="c1">// FIXME use make_shared if necessary</span>
<span class="w">  </span><span class="n">TcpConnectionPtr</span><span class="w"> </span><span class="nf">conn</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TcpConnection</span><span class="p">(</span><span class="n">ioLoop</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">connName</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">sockfd</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">localAddr</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">peerAddr</span><span class="p">));</span><span class="c1">//构建了一个connection</span>
<span class="w">  </span><span class="n">connections_</span><span class="p">[</span><span class="n">connName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">;</span><span class="c1">//将新构建的con加入server的map中</span>
<span class="w">  </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">connectionCallback_</span><span class="p">);</span><span class="c1">//muduo默认的</span>
<span class="w">  </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">messageCallback_</span><span class="p">);</span><span class="c1">//moduo默认的</span>
<span class="w">  </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">setWriteCompleteCallback</span><span class="p">(</span><span class="n">writeCompleteCallback_</span><span class="p">);</span><span class="c1">//？？</span>
<span class="w">  </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">setCloseCallback</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnection</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">));</span><span class="w"> </span><span class="c1">// FIXME: unsafe</span>
<span class="w">  </span><span class="n">ioLoop</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectEstablished</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">));</span><span class="c1">//在某个线程池的loop中加入这个con</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>下面接着讲述在TcpServer的构造过程中发生的事情：创建Acceptor对象。TcpServer用unique_ptr持有唯一的指向Acceptor的指针。Acceptor的构造函数完成了一些常见的选项。最后的一个向Acceptor-&gt;Channel注册一个回调函数，用于处理：listening可读时（新的连接到来），该怎么办？答案是：当新的连接到来时，创建一个已连接描述符，然后调用TcpServe注册给Acceptor的回调函数，用于处理新的连接。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">Acceptor</span><span class="o">::</span><span class="n">Acceptor</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span><span class="w"> </span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">InetAddress</span><span class="o">&amp;</span><span class="w"> </span><span class="n">listenAddr</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">reuseport</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">acceptSocket_</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">createNonblockingOrDie</span><span class="p">(</span><span class="n">listenAddr</span><span class="p">.</span><span class="n">family</span><span class="p">())),</span><span class="w"></span>
<span class="w">    </span><span class="n">acceptChannel_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">fd</span><span class="p">()),</span><span class="w"></span>
<span class="w">    </span><span class="n">listenning_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">idleFd_</span><span class="p">(</span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/null&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CLOEXEC</span><span class="p">))</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">idleFd_</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">setReuseAddr</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">setReusePort</span><span class="p">(</span><span class="n">reuseport</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">bindAddress</span><span class="p">(</span><span class="n">listenAddr</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">acceptChannel_</span><span class="p">.</span><span class="n">setReadCallback</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Acceptor</span><span class="o">::</span><span class="n">handleRead</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">));</span><span class="c1">//Channel设置回调，当sockfd可读时掉用设置的回调</span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="n">Acceptor</span><span class="o">::</span><span class="n">handleRead</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//判断是否在IO线程</span>
<span class="w">  </span><span class="n">InetAddress</span><span class="w"> </span><span class="n">peerAddr</span><span class="p">;</span><span class="c1">//客户的地址</span>
<span class="w">  </span><span class="c1">//FIXME loop until no more</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">connfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peerAddr</span><span class="p">);</span><span class="c1">//获得连接的描述符</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connfd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// string hostport = peerAddr.toIpPort();</span>
<span class="w">    </span><span class="c1">// LOG_TRACE &lt;&lt; &quot;Accepts of &quot; &lt;&lt; hostport;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newConnectionCallback_</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newConnectionCallback_</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span><span class="w"> </span><span class="n">peerAddr</span><span class="p">);</span><span class="c1">//TcpServer注册的，创建新的con,并且加入TcpServer的ConnectionMap中。</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">LOG_SYSERR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;in Acceptor::handleRead&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Read the section named &quot;The special problem of</span>
<span class="w">    </span><span class="c1">// accept()ing when you can&#39;t&quot; in libev&#39;s doc.</span>
<span class="w">    </span><span class="c1">// By Marc Lehmann, author of libev.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">errno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EMFILE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">idleFd_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">idleFd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">accept</span><span class="p">(</span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">fd</span><span class="p">(),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">idleFd_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">idleFd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/null&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CLOEXEC</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>在上述Acceptor对象的创建过程中，Acceptor会创建一个用于处理监听套接字事件的Channel对象，以下Acceptor的Channel对象的创造过程，很常规的处理过程。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">Channel</span><span class="o">::</span><span class="n">Channel</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span><span class="w"> </span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fd__</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">fd_</span><span class="p">(</span><span class="n">fd__</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">events_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">revents_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">index_</span><span class="p">(</span><span class="mi">-1</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">logHup_</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">tied_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">eventHandling_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">addedToLoop_</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>到此，在muduo库内部的初始化过程已经基本处理完毕，然后由用户调用TcpServer的setThreadNum()和start()函数。在start()函数中会将打开Acceptor对象linten套接字。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">TcpServer::setThreadNum</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">numThreads</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="c1">//设置线程池的开始数目</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">numThreads</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">threadPool_</span><span class="o">-&gt;</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">TcpServer::start</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="c1">//TcpServer开始工作</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">started_</span><span class="p">.</span><span class="n">getAndSet</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="c1">//获得原子计数</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">threadPool_</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">threadInitCallback_</span><span class="p">);</span><span class="c1">//线程池开始工作</span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">acceptor_</span><span class="o">-&gt;</span><span class="n">listenning</span><span class="p">());</span><span class="c1">//打开accepor的监听状态</span>
<span class="w">    </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Acceptor</span><span class="o">::</span><span class="n">listen</span><span class="p">,</span><span class="w"> </span><span class="n">get_pointer</span><span class="p">(</span><span class="n">acceptor_</span><span class="p">)));</span><span class="c1">//打开acceptor的listening</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>打开Acceptor对象的listenfd的详细过程。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Acceptor::listen</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//判断是否在IO线程</span>
<span class="w">  </span><span class="n">listenning_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="c1">//进入监听模式</span>
<span class="w">  </span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">listen</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">acceptChannel_</span><span class="p">.</span><span class="n">enableReading</span><span class="p">();</span><span class="c1">//让监听字的channel关注可读事件</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>接着使用了Channel对象中的的enableReading()函数，让这个Channel对象关注可读事件。关键在于更新过程，应该是这个流程中最重要的操作。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">enableReading</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">events_</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">kReadEvent</span><span class="p">;</span><span class="w"> </span><span class="n">update</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="c1">//将关注的事件变为可读，然后更新</span>
</code></pre></div>
<ul>
<li>使用了Channel的更新函数：update()</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Channel::update</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">addedToLoop_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="c1">//更新channel的状态</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">updateChannel</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="c1">//调用POLLER的更新功能</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>EventLoop持有唯一的Poller，也就是说，这个Poller将负责最后的更新过程。如果是新的Channel对象，则在Poller的pollfd数组中增加席位；如果不是新的Channel对象，则更新它目前所发生的事件（将目前发生的事件设置为0）。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">EventLoop::updateChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ownerLoop</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="c1">//判断channel的LOOP是否是当前的LOOP</span>
<span class="w">  </span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//判断是否在IO线程</span>
<span class="w">  </span><span class="n">poller_</span><span class="o">-&gt;</span><span class="n">updateChannel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span><span class="c1">//使用POLLER来更新channel</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>紧接着使用了Poller的updateChannel函数</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">PollPoller::updateChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="c1">//将channel关注的事件与pollfd同步</span>
<span class="w">  </span><span class="n">Poller</span><span class="o">::</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//如果不再loop线程直接退出</span>
<span class="w">  </span><span class="n">LOG_TRACE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;fd = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; events = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="c1">//获得channel在map中的位置</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// a new one, add to pollfds_</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pollfd</span><span class="w"> </span><span class="n">pfd</span><span class="p">;</span><span class="c1">//新建一个pfd与channel相关联</span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">());</span><span class="c1">//关注的事件设置为channel关注的事件</span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="c1">//正在发生的事件为0</span>
<span class="w">    </span><span class="n">pollfds_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pfd</span><span class="p">);</span><span class="c1">//将设置好的pollfd加入关注事件列表</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pollfds_</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="mi">-1</span><span class="p">;</span><span class="c1">//并且获得加入的位置</span>
<span class="w">    </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span><span class="c1">//channel保存自己在pollfds中的位置</span>
<span class="w">    </span><span class="n">channels_</span><span class="p">[</span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span><span class="c1">//channel将自己加入到channelmap中</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// update existing one</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">channel</span><span class="p">);</span><span class="c1">//判断位置是否正确</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">();</span><span class="c1">//获得channel在pollfd中的索引</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pollfds_</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pollfd</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pollfds_</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="c1">//获得索引</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">());</span><span class="c1">//修改关注的事件</span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="c1">//将当前发生的事件设置为0</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">isNoneEvent</span><span class="p">())</span><span class="c1">//如果channel没有任何事件，一个暂时熄火的channel</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// ignore this pollfd</span>
<span class="w">      </span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="mi">-1</span><span class="p">;</span><span class="c1">//将索引设置为原来索引的负数</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>至此，调用EventLoop的loop函数，进行loop循环，开始处理事件。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">EventLoop::loop</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">looping_</span><span class="p">);</span><span class="c1">//判断是否在LOOPING</span>
<span class="w">  </span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//判断这个函数在LOOP线程调用</span>
<span class="w">  </span><span class="n">looping_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="c1">//进入LOOPING状态</span>
<span class="w">  </span><span class="n">quit_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// FIXME: what if someone calls quit() before loop() ?</span>
<span class="w">  </span><span class="n">LOG_TRACE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;EventLoop &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; start looping&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">quit_</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">activeChannels_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="c1">//将活动线程队列置空</span>
<span class="w">    </span><span class="n">pollReturnTime_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poller_</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">kPollTimeMs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">activeChannels_</span><span class="p">);</span><span class="c1">//获得活动文件描述符的数量，并且获得活动的channel队列</span>
<span class="w">    </span><span class="o">++</span><span class="n">iteration_</span><span class="p">;</span><span class="c1">//增加Poll次数</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Logger</span><span class="o">::</span><span class="n">logLevel</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Logger</span><span class="o">::</span><span class="n">TRACE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">printActiveChannels</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO sort channel by priority</span>
<span class="w">    </span><span class="n">eventHandling_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="c1">//事件处理状态</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ChannelList</span><span class="o">::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeChannels_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">activeChannels_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">currentActiveChannel_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span><span class="c1">//获得当前活动的事件</span>
<span class="w">      </span><span class="n">currentActiveChannel_</span><span class="o">-&gt;</span><span class="n">handleEvent</span><span class="p">(</span><span class="n">pollReturnTime_</span><span class="p">);</span><span class="c1">//处理事件，传递一个poll的阻塞时间</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">currentActiveChannel_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="c1">//将当前活动事件置为空</span>
<span class="w">    </span><span class="n">eventHandling_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="c1">//退出事件处理状态</span>
<span class="w">    </span><span class="n">doPendingFunctors</span><span class="p">();</span><span class="c1">//处理用户在其他线程注册给IO线程的事件</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">LOG_TRACE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;EventLoop &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; stop looping&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">looping_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="c1">//推出LOOPING状态</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>一个监听套接字已经进入循环，如果此时一个新的连接到来又会发生什么事情呢？</p>
<h3 id="_1">一个新连接到达时的处理过程。<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<ul>
<li>此时在loop循环中的监听套接字变得可读，然后便调用一个可读事件的处理对象。首先调用Acceptor注册的handleRead对象，完成连接套接字的创建，其次在handleRead对象的内部调用TcpServer注册给Acceptor的函数对象，用于将新建con对象加入TcpServer的ConnectionMap中去。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Channel::handleEvent</span><span class="p">(</span><span class="n">Timestamp</span><span class="w"> </span><span class="n">receiveTime</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">guard</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tied_</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">guard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tie_</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span><span class="c1">//提升成功说明con存在</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">guard</span><span class="p">)</span><span class="c1">//这样做比较保险</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">handleEventWithGuard</span><span class="p">(</span><span class="n">receiveTime</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">handleEventWithGuard</span><span class="p">(</span><span class="n">receiveTime</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Channel::handleEventWithGuard</span><span class="p">(</span><span class="n">Timestamp</span><span class="w"> </span><span class="n">receiveTime</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="c1">//真正的处理各种事件</span>
<span class="w">  </span><span class="n">eventHandling_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="c1">//处理事件状态</span>
<span class="w">  </span><span class="n">LOG_TRACE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">reventsToString</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">revents_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">POLLHUP</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">revents_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">POLLIN</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logHup_</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">LOG_WARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;fd = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fd_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; Channel::handle_event() POLLHUP&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">closeCallback_</span><span class="p">)</span><span class="w"> </span><span class="n">closeCallback_</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">revents_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">POLLNVAL</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">LOG_WARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;fd = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fd_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; Channel::handle_event() POLLNVAL&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">revents_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">POLLERR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">POLLNVAL</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">errorCallback_</span><span class="p">)</span><span class="w"> </span><span class="n">errorCallback_</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">revents_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">POLLIN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">POLLPRI</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">POLLRDHUP</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readCallback_</span><span class="p">)</span><span class="w"> </span><span class="n">readCallback_</span><span class="p">(</span><span class="n">receiveTime</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">revents_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">POLLOUT</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">writeCallback_</span><span class="p">)</span><span class="w"> </span><span class="n">writeCallback_</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">eventHandling_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>此时，监听套接字处理的时可读事件，调用之前由Acceptor注册的handleRead回调函数</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Acceptor::handleRead</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//判断是否在IO线程</span>
<span class="w">  </span><span class="n">InetAddress</span><span class="w"> </span><span class="n">peerAddr</span><span class="p">;</span><span class="c1">//客户的地址</span>
<span class="w">  </span><span class="c1">//FIXME loop until no more</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">connfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peerAddr</span><span class="p">);</span><span class="c1">//获得连接的描述符</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connfd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// string hostport = peerAddr.toIpPort();</span>
<span class="w">    </span><span class="c1">// LOG_TRACE &lt;&lt; &quot;Accepts of &quot; &lt;&lt; hostport;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newConnectionCallback_</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newConnectionCallback_</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span><span class="w"> </span><span class="n">peerAddr</span><span class="p">);</span><span class="c1">//这是个关键步骤，重点在于这个回调是谁注册的</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">LOG_SYSERR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;in Acceptor::handleRead&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Read the section named &quot;The special problem of</span>
<span class="w">    </span><span class="c1">// accept()ing when you can&#39;t&quot; in libev&#39;s doc.</span>
<span class="w">    </span><span class="c1">// By Marc Lehmann, author of libev.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">errno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EMFILE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">idleFd_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">idleFd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">accept</span><span class="p">(</span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">fd</span><span class="p">(),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">idleFd_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">idleFd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/null&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CLOEXEC</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>在上述函数中又调用，由TcpServer注册给Acceptor的回调函数</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">TcpServer::newConnection</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">InetAddress</span><span class="o">&amp;</span><span class="w"> </span><span class="n">peerAddr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="c1">//将本函数注册个acceptor</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//断言是否在IO线程</span>
<span class="w">  </span><span class="n">EventLoop</span><span class="o">*</span><span class="w"> </span><span class="n">ioLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadPool_</span><span class="o">-&gt;</span><span class="n">getNextLoop</span><span class="p">();</span><span class="c1">//获得线程池中的一个loop</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span><span class="c1">//获得线程池map中的string索引</span>
<span class="w">  </span><span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-%s#%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ipPort_</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">nextConnId_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="o">++</span><span class="n">nextConnId_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">string</span><span class="w"> </span><span class="n">connName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">LOG_INFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;TcpServer::newConnection [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name_</span><span class="w"></span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] - new connection [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">connName</span><span class="w"></span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] from &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">peerAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">InetAddress</span><span class="w"> </span><span class="n">localAddr</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">getLocalAddr</span><span class="p">(</span><span class="n">sockfd</span><span class="p">));</span><span class="c1">//获得本地的地址，用于构建Connection</span>
<span class="w">  </span><span class="c1">// FIXME poll with zero timeout to double confirm the new connection</span>
<span class="w">  </span><span class="c1">// FIXME use make_shared if necessary</span>
<span class="w">  </span><span class="n">TcpConnectionPtr</span><span class="w"> </span><span class="n">conn</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TcpConnection</span><span class="p">(</span><span class="n">ioLoop</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">connName</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">sockfd</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">localAddr</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">peerAddr</span><span class="p">));</span><span class="c1">//构建了一个connection</span>
<span class="n">connections_</span><span class="p">[</span><span class="n">connName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">;</span><span class="c1">//将新构建的con加入server的map中</span>
<span class="w">  </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">connectionCallback_</span><span class="p">);</span><span class="c1">//muduo默认的</span>
<span class="w">  </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">messageCallback_</span><span class="p">);</span><span class="c1">//moduo默认的</span>
<span class="w">  </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">setWriteCompleteCallback</span><span class="p">(</span><span class="n">writeCompleteCallback_</span><span class="p">);</span><span class="c1">//？？</span>
<span class="w">  </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">setCloseCallback</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnection</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">));</span><span class="w"> </span><span class="c1">// FIXME: unsafe</span>
<span class="w">  </span><span class="n">ioLoop</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectEstablished</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">));</span><span class="c1">//在某个线程池的loop中加入这个con</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>上述对象的最后一行，是调用新建的TcpConnection对象的函数，用设置新建的con对象中的channel的关注事件。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">TcpConnection::connectEstablished</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="c1">//建立连接</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//断言是否在IO线程</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kConnecting</span><span class="p">);</span><span class="c1">//正处于连接建立过程</span>
<span class="w">  </span><span class="n">setState</span><span class="p">(</span><span class="n">kConnected</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">tie</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span><span class="c1">//使channel的tie的指向不为空</span>
<span class="w">  </span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">enableReading</span><span class="p">();</span><span class="c1">//将connection设置为可读的</span>

<span class="w">  </span><span class="n">connectionCallback_</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span><span class="c1">//用户提供的回调函数，muduo有提供默认的</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>至此以后的过程与将listen-&gt;channel添加到loop中的过程一样。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">enableReading</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">events_</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">kReadEvent</span><span class="p">;</span><span class="w"> </span><span class="n">update</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="c1">//将关注的事件变为可读，然后更新</span>
</code></pre></div>
<ul>
<li>使用了Channel的更新函数：update()</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Channel::update</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">addedToLoop_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="c1">//更新channel的状态</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">updateChannel</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="c1">//调用POLLER的更新功能</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>使用了EventLoop的updateChannel()功能</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">EventLoop::updateChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ownerLoop</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="c1">//判断channel的LOOP是否是当前的LOOP</span>
<span class="w">  </span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//判断是否在IO线程</span>
<span class="w">  </span><span class="n">poller_</span><span class="o">-&gt;</span><span class="n">updateChannel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span><span class="c1">//使用POLLER来更新channel</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>在poller中更新channel</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">PollPoller::updateChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="c1">//将channel关注的事件与pollfd同步</span>
<span class="w">  </span><span class="n">Poller</span><span class="o">::</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//如果不再loop线程直接退出</span>
<span class="w">  </span><span class="n">LOG_TRACE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;fd = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; events = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="c1">//获得channel在map中的位置</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// a new one, add to pollfds_</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pollfd</span><span class="w"> </span><span class="n">pfd</span><span class="p">;</span><span class="c1">//新建一个pfd与channel相关联</span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">());</span><span class="c1">//关注的事件设置为channel关注的事件</span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="c1">//正在发生的事件为0</span>
<span class="w">    </span><span class="n">pollfds_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pfd</span><span class="p">);</span><span class="c1">//将设置好的pollfd加入关注事件列表</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pollfds_</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="mi">-1</span><span class="p">;</span><span class="c1">//并且获得加入的位置</span>
<span class="w">    </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span><span class="c1">//channel保存自己在pollfds中的位置</span>
<span class="w">    </span><span class="n">channels_</span><span class="p">[</span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span><span class="c1">//channel将自己加入到channelmap中</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// update existing one</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">channel</span><span class="p">);</span><span class="c1">//判断位置是否正确</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">();</span><span class="c1">//获得channel在pollfd中的索引</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pollfds_</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pollfd</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pollfds_</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="c1">//获得索引</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">());</span><span class="c1">//修改关注的事件</span>
<span class="w">    </span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="c1">//将当前发生的事件设置为0</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">isNoneEvent</span><span class="p">())</span><span class="c1">//如果channel没有任何事件，一个暂时熄火的channel</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// ignore this pollfd</span>
<span class="w">      </span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="mi">-1</span><span class="p">;</span><span class="c1">//将索引设置为原来索引的负数</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>最后一个连接的channel加入loop循环，新的循环已经开始了。</p>
<h2 id="muduo_1">模拟单线程情况下muduo库的工作情况<a class="headerlink" href="#muduo_1" title="Permanent link">&para;</a></h2>
<p>在上篇中，笔者追踪了Connetfd（连接套接字）和Listenfd（监听套接字）的Channel对象加入到loop循环的过程。其中包括了网络连接过程中，muduo会创建的对象。本文将会追踪Connetfd（连接套接字）和Listenfd（监听套接字）从loop循环退出并且销毁，一直到main函数终止的过程。</p>
<h3 id="read-0">连接套接字正常情况下完整的销毁情况（read == 0）<a class="headerlink" href="#read-0" title="Permanent link">&para;</a></h3>
<p>由TcpConnection对象向自己所拥有的Channel对象注册的可读事件结束时，会出现<code>read == 0</code>的情况，此时会直接调用TcpConnection对象的handleClose函数。因为在向Channel对象注册可读事件时，使用了如下的语句：</p>
<div class="highlight"><pre><span></span><code><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">setReadCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleRead</span><span class="p">,</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>**this**使得Channel对象可以直接在TcpConnection向它注册的handleClose函数内部使用TcpConnetion的函数。</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">TcpConnection::handleRead</span><span class="p">(</span><span class="n">Timestamp</span><span class="w"> </span><span class="n">receiveTime</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="c1">//都是向channel注册的函数</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//断言在loop线程</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">savedErrno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="c1">//在读取数据之后调用用户提供的回调函数</span>
<span class="w">  </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputBuffer_</span><span class="p">.</span><span class="n">readFd</span><span class="p">(</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">savedErrno</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="c1">//这个应该时用户提供的处理信息的回调函数</span>
<span class="w">    </span><span class="n">messageCallback_</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">inputBuffer_</span><span class="p">,</span><span class="w"> </span><span class="n">receiveTime</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="c1">//读到了0,直接关闭</span>
<span class="w">    </span><span class="n">handleClose</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="c1">//如果有错误</span>
<span class="w">    </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">savedErrno</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">LOG_SYSERR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;TcpConnection::handleRead&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">handleError</span><span class="p">();</span><span class="c1">//处理关闭</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">TcpConnection::handleClose</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="c1">//处理关闭事件</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//断言是否在loop线程</span>
<span class="w">  </span><span class="n">LOG_TRACE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;fd = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; state = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">stateToString</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kConnected</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kDisconnecting</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// we don&#39;t close fd, leave it to dtor, so we can find leaks easily.</span>
<span class="w">  </span><span class="n">setState</span><span class="p">(</span><span class="n">kDisconnected</span><span class="p">);</span><span class="c1">//设置关闭状态</span>
<span class="w">  </span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">disableAll</span><span class="p">();</span><span class="c1">//不再关注任何事情</span>

<span class="w">  </span><span class="n">TcpConnectionPtr</span><span class="w"> </span><span class="n">guardThis</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span><span class="c1">//获得shared_ptr交由tcpsever处理</span>
<span class="w">  </span><span class="n">connectionCallback_</span><span class="p">(</span><span class="n">guardThis</span><span class="p">);</span><span class="c1">//这他妈就是记录一点日志</span>
<span class="w">  </span><span class="c1">// must be the last line</span>
<span class="w">  </span><span class="n">closeCallback_</span><span class="p">(</span><span class="n">guardThis</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>在以上的handleClose代码中，首先会设置TcpConnection对象的关闭状态，其次让自己Channel对象不再关注任何事情。
因为TcpConnection在创建时使用了如下语句：</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TcpConnection</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">boost</span><span class="o">::</span><span class="n">enable_shared_from_this</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<p>便可以使用shared_fron_this()获得指向本TcpConnection对象的shared_ptr指针，然后在后续的过程中，对指向本对象的
shared_ptr进行操作，则可以安全的将本对象从其他依赖类中安全的移除。
继续跟踪上述的最后一句，且closeCallback是由TcpServer在创建TcpConnection对象时向它注册的：</p>
<div class="highlight"><pre><span></span><code><span class="n">conn</span><span class="o">-&gt;</span><span class="n">setCloseCallback</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnection</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">));</span><span class="w"></span>
</code></pre></div>
<p>目的在于在TcpServer的TcpconnectionMap中移除指向指向这个TcpConnection对象的指针。</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">TcpServer::removeConnection</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// FIXME: unsafe</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnectionInLoop</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">));</span><span class="c1">//注册到loop线程中移除这个con</span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">TcpServer::removeConnectionInLoop</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//断言是否在IO线程</span>
<span class="w">  </span><span class="n">LOG_INFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;TcpServer::removeConnectionInLoop [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name_</span><span class="w"></span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] - connection &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connections_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">());</span><span class="c1">//删除该con</span>
<span class="w">  </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">EventLoop</span><span class="o">*</span><span class="w"> </span><span class="n">ioLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">();</span><span class="c1">//获得线程Loop</span>
<span class="w">  </span><span class="n">ioLoop</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectDestroyed</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">));</span><span class="c1">//将线程销毁动作添加到loop中去</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>目前的步骤还在于处理TcpConnection对象。</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">TcpConnection::connectDestroyed</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="c1">//销毁连接</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//断言是否在loop线程</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kConnected</span><span class="p">)</span><span class="c1">//如果此时处于连接状态</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">setState</span><span class="p">(</span><span class="n">kDisconnected</span><span class="p">);</span><span class="c1">//将状态设置为不可连接状态</span>
<span class="w">    </span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">disableAll</span><span class="p">();</span><span class="c1">//channel不再关注任何事件</span>

<span class="w">    </span><span class="n">connectionCallback_</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span><span class="c1">//记录作用，好坑的一个作用</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">();</span><span class="c1">//在poller中移除channel</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>TcpConnection对象的声明周期随着将Channel对象移除出loop循环而结束。</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Channel::remove</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="c1">//将channel从loop中移除</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">isNoneEvent</span><span class="p">());</span><span class="c1">//判断此时的channel是否没有事件发生</span>
<span class="w">  </span><span class="n">addedToLoop_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="c1">//此时没有loop拥有此channel</span>
<span class="w">  </span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">removeChannel</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="c1">//调用POLLER的删除功能</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>因为EventLoop对象中的poller对象也持有Channel对象的指针，所以需要将channel对象安全的从poller对象中移除。</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">EventLoop::removeChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="c1">//每次间接的调用的作用就是将需要改动的东西与当前调用的类撇清关系</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ownerLoop</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//如果没有在loop线程调用直接退出</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eventHandling_</span><span class="p">)</span><span class="c1">//判断是否在事件处理状态。判断当前是否在处理这个将要删除的事件以及活动的事件表中是否有这个事件</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">currentActiveChannel_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">activeChannels_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">activeChannels_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">activeChannels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">poller_</span><span class="o">-&gt;</span><span class="n">removeChannel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span><span class="c1">//在POLLER中删除这个事件分发表</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>以下时Poller对象移除Channel对象的具体操作步骤。</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">PollPoller::removeChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Poller</span><span class="o">::</span><span class="n">assertInLoopThread</span><span class="p">();</span><span class="c1">//判断是否在IO线程</span>
<span class="w">  </span><span class="n">LOG_TRACE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;fd = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">channel</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">isNoneEvent</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">();</span><span class="c1">//获得pfd位置的索引</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pollfds_</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pollfd</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pollfds_</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pfd</span><span class="p">;</span><span class="c1">//获得pfd</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span><span class="mi">-1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pfd</span><span class="p">.</span><span class="n">events</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channels_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">());</span><span class="c1">//在Map中删除channel</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">n</span><span class="p">;</span><span class="c1">//准备删除pollfd中的关注事件</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">implicit_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pollfds_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="mi">-1</span><span class="p">)</span><span class="c1">//获得pollfd的索引</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pollfds_</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="c1">//想方设法的删除pollfd中与channel相关的pfd</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">channelAtEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pollfds_</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">fd</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">iter_swap</span><span class="p">(</span><span class="n">pollfds_</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">pollfds_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channelAtEnd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">channelAtEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">channelAtEnd</span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">channels_</span><span class="p">[</span><span class="n">channelAtEnd</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pollfds_</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>以上便是一个连接的销毁过程，现在依然让人迷惑的时Channel对象到底被谁持有过？以及TcpConnection对象的生命周期到底在什么时候结束？</p>
<h3 id="channeltcpconnection">Channel与TcpConnection对象的创建与销毁<a class="headerlink" href="#channeltcpconnection" title="Permanent link">&para;</a></h3>
<h4 id="_2">创建<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>下面，在让我们进入上一篇文章，具体的看看Channel对象的生命期到底是个什么样子？</p>
<ul>
<li>当新连接过来时，由TcpServer创建一个TcpConnection对象，这个对象中包括一个与此连接相关的Channel对象。</li>
<li>然后紧接着TcpServer使用创建的TcpConnection对象向Loop中注册事件。此时的控制权回到TcpConnection对象手中。它操作自己的Channel对象更新EventLoop。</li>
<li>最后由EventLoop对象去操作自己的Poller更新Poller的Channel队列。
  在上述过程中，Channel对象的创建操作有这样的顺序：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">TcpServer</span><span class="o">-&gt;</span><span class="n">TcpConnection</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="o">-&gt;</span><span class="n">EventLoop</span><span class="o">-&gt;</span><span class="n">Poller</span><span class="w"></span>
</code></pre></div>
<p>TcpConnection对象的创建过程相比于Channel简单的多：</p>
<div class="highlight"><pre><span></span><code><span class="n">TcpServer</span><span class="o">-&gt;</span><span class="n">TcpConnection</span><span class="w"></span>
</code></pre></div>
<p>在TcpServer中创建Connection对象，然后让TcpConnection对象去操作自己的Channel对象，将Channel加入到EventLoop中去，最后由EventLoop操作自己的Poller收尾。总而言之，Channel对象在整个过程中只由Poller和TcpConnection对象持有，销毁时也应该是如此过程。</p>
<h4 id="_3">销毁<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>由于Channel是TcpConnection对象的一部分，所以Channel的生命周期一定会比TcpConnection的短。
Channel与TcpConnection对象的销毁基本与上述创建过程相同：</p>
<div class="highlight"><pre><span></span><code><span class="n">TcpConnection</span><span class="o">-&gt;</span><span class="n">TcpServer</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="o">-&gt;</span><span class="n">EventLoop</span><span class="o">-&gt;</span><span class="n">Poller</span><span class="w"></span>
</code></pre></div>
<p>随着，Channel对象从Poller中移除，TcpConnection的生命周期也随之结束。
TcpConnection对象在整个生命周期中只由TcpServer持有，但是TcpConnection对象中的Channel又由Poller持有，Poller又是EventLoop的唯一成员，所以造成了如此麻烦的清理与创建过程。那如果能将Channel移出TcpConnection对象，那muduo的创建与清理工作会不会轻松很多？</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
        <script src="../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>